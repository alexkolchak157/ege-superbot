-- –ú–∏–≥—Ä–∞—Ü–∏—è: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ–π –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ —É—á–∏—Ç–µ–ª—è
-- –î–∞—Ç–∞: 2025-12-16
-- –û–ø–∏—Å–∞–Ω–∏–µ: –†–∞–∑–¥–µ–ª—è–µ—Ç AI feedback –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —É—á–∏—Ç–µ–ª—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è
--           –Ω–µ–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ–≥–æ —Ä–æ—Å—Ç–∞ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö

-- –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∫–æ–ª–æ–Ω–∫—É –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ —É—á–∏—Ç–µ–ª—è
ALTER TABLE homework_progress
ADD COLUMN teacher_comment TEXT;

-- –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
ALTER TABLE homework_progress
ADD COLUMN teacher_comment_at TEXT;

-- –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ —É—á–∏—Ç–µ–ª—è
CREATE INDEX IF NOT EXISTS idx_homework_progress_teacher_comment
ON homework_progress(homework_id)
WHERE teacher_comment IS NOT NULL;

-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: –¢–µ–ø–µ—Ä—å –≤ —Ç–∞–±–ª–∏—Ü–µ homework_progress –µ—Å—Ç—å:
-- - ai_feedback: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –æ—Ç AI (–Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è —É—á–∏—Ç–µ–ª–µ–º)
-- - teacher_comment: –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É—á–∏—Ç–µ–ª—è (–º–æ–∂–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è)
-- - teacher_comment_at: –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è —É—á–∏—Ç–µ–ª—è

-- –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö: –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —É—á–∏—Ç–µ–ª—è –∏–∑ ai_feedback
-- –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç, —á—Ç–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —É—á–∏—Ç–µ–ª—è –¥–æ–±–∞–≤–ª–µ–Ω—ã —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º "üë®‚Äçüè´"
UPDATE homework_progress
SET teacher_comment =
    CASE
        WHEN ai_feedback LIKE '%üë®‚Äçüè´ <b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É—á–∏—Ç–µ–ª—è:</b>%'
        THEN SUBSTR(
            ai_feedback,
            INSTR(ai_feedback, 'üë®‚Äçüè´ <b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É—á–∏—Ç–µ–ª—è:</b>') + 35
        )
        ELSE NULL
    END
WHERE ai_feedback LIKE '%üë®‚Äçüè´ <b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É—á–∏—Ç–µ–ª—è:</b>%';

-- –û—á–∏—â–∞–µ–º ai_feedback –æ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ —É—á–∏—Ç–µ–ª—è
UPDATE homework_progress
SET ai_feedback =
    TRIM(SUBSTR(
        ai_feedback,
        1,
        INSTR(ai_feedback, 'üë®‚Äçüè´ <b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É—á–∏—Ç–µ–ª—è:</b>') - 1
    ))
WHERE ai_feedback LIKE '%üë®‚Äçüè´ <b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É—á–∏—Ç–µ–ª—è:</b>%';

import logging
import json
from typing import Dict, Any, List, Optional, Tuple
from core.ai_service import get_ai_service

logger = logging.getLogger(__name__)


class PlanAIChecker:
    """AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–ª–∞–Ω–æ–≤ –ø–æ –æ–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏—é (–ó–∞–¥–∞–Ω–∏–µ 24 –ï–ì–≠)"""
    
    def __init__(self):
        self.ai_service = get_ai_service()
        
        # ========== –ù–û–í–û–ï: –Ø–∫–æ—Ä–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –º–µ—Ç–æ–¥–∏—á–∫–∏ ==========
        self.ANCHOR_EXAMPLES = """
–ü–†–ò–ú–ï–†–´ –ò–ó –û–§–ò–¶–ò–ê–õ–¨–ù–û–ô –ú–ï–¢–û–î–ò–ß–ö–ò –ö–ò–ú –ï–ì–≠ 2024:

‚ùå –ü–†–ò–ú–ï–† –û–®–ò–ë–ö–ò (–ö2 = 0):
–ü–ª–∞–Ω ‚Ññ2 –ø–æ —Ç–µ–º–µ "–ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä—Ç–∏–∏":
- –ü—É–Ω–∫—Ç "–≥) –ª–∏—à–Ω—è—è, –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è" ‚Üí –û–®–ò–ë–ö–ê
- –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞: –ö1=3, –ö2=0
- –ü—Ä–∏—á–∏–Ω–∞: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –≤ –ø–æ–¥–ø—É–Ω–∫—Ç–µ

‚ùå –ü–†–ò–ú–ï–† –ú–ù–û–ñ–ï–°–¢–í–ï–ù–ù–´–• –û–®–ò–ë–û–ö (–ö2 = 0):
–ü–ª–∞–Ω ‚Ññ5:
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ "–æ—à–∏–±–∫–∞/–Ω–µ—Ç–æ—á–Ω–æ—Å—Ç—å"
- –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞: –ö1=3, –ö2=0
- –ü—Ä–∏—á–∏–Ω–∞: –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫

‚ùå –ü–†–ò–ú–ï–† –ù–ï–î–û–°–¢–ê–¢–û–ß–ù–û–ô –î–ï–¢–ê–õ–ò–ó–ê–¶–ò–ò (–ö1 = 0):
–ü–ª–∞–Ω ‚Ññ9:
- "–≤–æ–∑–º–æ–∂–Ω–æ —Ç—Ä–∏ –∏ –±–æ–ª–µ–µ –ø–æ–¥–ø—É–Ω–∫—Ç–∞" (—Ç–æ–ª—å–∫–æ 2 –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö)
- –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞: –ö1=0, –ö2=0
- –ü—Ä–∏—á–∏–Ω–∞: –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫—Ä–∏—Ç–µ—Ä–∏—é "—Å–ª–æ–∂–Ω—ã–π –ø–ª–∞–Ω"

‚ö†Ô∏è –ê–ë–°–¢–†–ê–ö–¢–ù–û-–§–û–†–ú–ê–õ–¨–ù–´–ï –ü–£–ù–ö–¢–´ (–ù–ï –ó–ê–°–ß–ò–¢–´–í–ê–Æ–¢–°–Ø):
- "–ü–æ–Ω—è—Ç–∏–µ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–æ–π –ø–∞—Ä—Ç–∏–∏" –ë–ï–ó —Ä–∞—Å–∫—Ä—ã—Ç–∏—è
- "–í–∏–¥—ã..." –ë–ï–ó –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –≤–∏–¥–æ–≤
- "–§—É–Ω–∫—Ü–∏–∏..." –ë–ï–ó –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π
–í–ê–ñ–ù–û: –¢–∞–∫–∏–µ –ø—É–Ω–∫—Ç—ã –Ω–µ —Å—á–∏—Ç–∞—é—Ç—Å—è —Ä–∞—Å–∫—Ä—ã–≤–∞—é—â–∏–º–∏ —Ç–µ–º—É!

‚úÖ –ü–†–ê–í–ò–õ–û –ü–†–û 2 –ü–û–î–ü–£–ù–ö–¢–ê:
"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–ø—É–Ω–∫—Ç–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ —Ç—Ä—ë—Ö, 
–ó–ê –ò–°–ö–õ–Æ–ß–ï–ù–ò–ï–ú —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è 
–æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –Ω–∞—É–∫ –≤–æ–∑–º–æ–∂–Ω—ã —Ç–æ–ª—å–∫–æ –¥–≤–∞ –ø–æ–¥–ø—É–Ω–∫—Ç–∞"
–ü—Ä–∏–º–µ—Ä—ã –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö 2 –ø–æ–¥–ø—É–Ω–∫—Ç–æ–≤:
- –£—Ä–æ–≤–Ω–∏ –Ω–∞—É—á–Ω–æ–≥–æ –ø–æ–∑–Ω–∞–Ω–∏—è: —ç–º–ø–∏—Ä–∏—á–µ—Å–∫–∏–π, —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–π
- –¢–∏–ø—ã –ø–∞—Ä—Ç–∏–π–Ω—ã—Ö —Å–∏—Å—Ç–µ–º: –æ–¥–Ω–æ–ø–∞—Ä—Ç–∏–π–Ω–∞—è, –¥–≤—É—Ö–ø–∞—Ä—Ç–∏–π–Ω–∞—è (–≤ —É–∑–∫–æ–º —Å–º—ã—Å–ª–µ)
"""
    
    async def check_plan_relevance(
        self, 
        user_plan: str, 
        topic: str,
        etalon_points: List[Dict[str, Any]]
    ) -> Dict[str, Any]:
        """
        –£–õ–£–ß–®–ï–ù–ù–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –ø–ª–∞–Ω–∞ —Ç–µ–º–µ
        
        –ò–ó–ú–ï–ù–ï–ù–ò–Ø:
        - –î–æ–±–∞–≤–ª–µ–Ω—ã —è–∫–æ—Ä–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã
        - –ß—ë—Ç–∫–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤
        - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ-—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–µ –ø—É–Ω–∫—Ç—ã
        
        Returns:
            {
                "is_relevant": bool,
                "confidence": float (0-1),
                "issues": List[str],
                "suggestions": List[str],
                "missing_key_aspects": List[str],
                "coverage_score": float (0-1)
            }
        """
        etalon_text = self._format_etalon_points(etalon_points)
        
        # –ò–ó–ú–ï–ù–ï–ù–û: –ë–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–π system_prompt —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
        system_prompt = f"""–¢—ã - —Å—Ç—Ä–æ–≥–∏–π —ç–∫—Å–ø–µ—Ä—Ç –ï–ì–≠ –ø–æ –æ–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏—é, –ø—Ä–æ–≤–µ—Ä—è—é—â–∏–π –∑–∞–¥–∞–Ω–∏–µ 24.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –æ—Ü–µ–Ω–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–ª–∞–Ω–∞ —É—á–µ–Ω–∏–∫–∞ —Ç–µ–º–µ –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –ï–ì–≠ 2025.

{self.ANCHOR_EXAMPLES}

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
1. –î–ª—è –ö1=3 —Ç—Ä–µ–±—É–µ—Ç—Å—è –í–°–ï –¢–†–ò –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø—É–Ω–∫—Ç–∞ + –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –º–∏–Ω–∏–º—É–º 3 –ø—É–Ω–∫—Ç–æ–≤
2. –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ-—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –ù–ï –∑–∞—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è
3. –ë—É–¥—å –°–¢–†–û–ì–ò–ú, –Ω–æ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤—ã–º"""

        prompt = f"""–ü—Ä–æ–≤–µ—Ä—å –ø–ª–∞–Ω —É—á–µ–Ω–∏–∫–∞ –ø–æ —Ç–µ–º–µ: "{topic}"

–ü–ª–∞–Ω —É—á–µ–Ω–∏–∫–∞:
{user_plan}

–≠—Ç–∞–ª–æ–Ω–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã —Ç–µ–º—ã (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –ø—É–Ω–∫—Ç—ã –æ—Ç–º–µ—á–µ–Ω—ã):
{etalon_text}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –ï–ì–≠ 2025 –¥–ª—è "—Å–ª–æ–∂–Ω–æ–≥–æ –ø–ª–∞–Ω–∞":
- –ú–∏–Ω–∏–º—É–º 3 –ø—É–Ω–∫—Ç–∞, —Ä–∞—Å–∫—Ä—ã–≤–∞—é—â–∏—Ö —Ç–µ–º—É –ø–æ —Å—É—â–µ—Å—Ç–≤—É (–Ω–µ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ-—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–µ!)
- –ú–∏–Ω–∏–º—É–º 3 –∏–∑ –Ω–∏—Ö –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–¥–ø—É–Ω–∫—Ç–∞–º–∏
- –í –∫–∞–∂–¥–æ–º –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –ø—É–Ω–∫—Ç–µ –º–∏–Ω–∏–º—É–º 3 –ø–æ–¥–ø—É–Ω–∫—Ç–∞
  (–∏—Å–∫–ª—é—á–µ–Ω–∏–µ: 2 –ø–æ–¥–ø—É–Ω–∫—Ç–∞ –¥–æ–ø—É—Å—Ç–∏–º—ã, –µ—Å–ª–∏ –±–æ–ª—å—à–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é)

–ü–†–û–í–ï–†–¨ –ö–ê–ñ–î–´–ô –ü–£–ù–ö–¢:
1. –†–∞—Å–∫—Ä—ã–≤–∞–µ—Ç –ª–∏ –æ–Ω —Ç–µ–º—É –ü–û –°–£–©–ï–°–¢–í–£ –∏–ª–∏ —ç—Ç–æ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ-—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫?
   –ü—Ä–∏–º–µ—Ä –ü–õ–û–•–û–ì–û –ø—É–Ω–∫—Ç–∞: "–ü–æ–Ω—è—Ç–∏–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞" (–±–µ–∑ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è)
   –ü—Ä–∏–º–µ—Ä –•–û–†–û–®–ï–ì–û –ø—É–Ω–∫—Ç–∞: "–ü—Ä–∏–∑–Ω–∞–∫–∏ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞: –∞) —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è; –±) —Å—É–≤–µ—Ä–µ–Ω–∏—Ç–µ—Ç..."

2. –ï—Å—Ç—å –ª–∏ –í–°–ï –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –ø—É–Ω–∫—Ç—ã –∏–∑ —ç—Ç–∞–ª–æ–Ω–∞?

3. –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –ø—É–Ω–∫—Ç—ã?

–û—Ü–µ–Ω–∏:
1. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–ª–∞–Ω –∑–∞—è–≤–ª–µ–Ω–Ω–æ–π —Ç–µ–º–µ (is_relevant: true/false)
2. –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ –æ—Ü–µ–Ω–∫–µ (confidence: 0.0-1.0)
3. –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –ø–ª–∞–Ω–∞ (issues: —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫)
4. –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é (suggestions: —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫)
5. –ö–∞–∫–∏–µ –∫–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã —Ç–µ–º—ã —É–ø—É—â–µ–Ω—ã (missing_key_aspects: —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫)
6. –°—Ç–µ–ø–µ–Ω—å –ø–æ–∫—Ä—ã—Ç–∏—è —Ç–µ–º—ã (coverage_score: 0.0-1.0)

–û–±—Ä–∞—Ç–∏ –æ—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞:
- –í—Å–µ –ª–∏ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –ø—É–Ω–∫—Ç—ã –∏–∑ —ç—Ç–∞–ª–æ–Ω–∞ —Ä–∞—Å–∫—Ä—ã—Ç—ã –≤ –ø–ª–∞–Ω–µ —É—á–µ–Ω–∏–∫–∞
- –ù–µ—Ç –ª–∏ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ-—Ñ–æ—Ä–º–∞–ª—å–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤ –±–µ–∑ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –æ–±—â–µ—Å—Ç–≤–æ–≤–µ–¥—á–µ—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤
- –õ–æ–≥–∏—á–µ—Å–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–∑–ª–æ–∂–µ–Ω–∏—è
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ–¥–ø—É–Ω–∫—Ç–æ–≤ –æ—Å–Ω–æ–≤–Ω—ã–º –ø—É–Ω–∫—Ç–∞–º"""

        try:
            result = await self.ai_service.get_json_completion(
                prompt,
                system_prompt=system_prompt,
                temperature=0.2  # –ù–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è —Å—Ç—Ä–æ–≥–æ—Å—Ç–∏
            )

            if not result:
                logger.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç AI")
                return self._default_relevance_result()

            return self._validate_relevance_result(result)
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏: {e}")
            return self._default_relevance_result()
    
    async def check_factual_errors(
        self,
        user_plan: str,
        topic: str,
        etalon_data: Optional[Dict[str, Any]] = None
    ) -> List[Dict[str, str]]:
        """
        –ö–†–ò–¢–ò–ß–ï–°–ö–ò –£–õ–£–ß–®–ï–ù–ù–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
        
        –ò–ó–ú–ï–ù–ï–ù–ò–Ø:
        - ‚úÖ –°—Ç—Ä–æ–≥–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ, —á—Ç–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è "–æ—à–∏–±–∫–æ–π" –¥–ª—è –ö2=0
        - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –º–µ—Ç–æ–¥–∏—á–∫–∏
        - ‚úÖ –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Å–Ω–∏–∂–µ–Ω–∞ –¥–æ 0.1 –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏
        - ‚úÖ –ß—ë—Ç–∫–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è severity
        
        –í–ê–ñ–ù–û: –ü–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º –ï–ì–≠ –û–î–ù–ê –æ—à–∏–±–∫–∞ = –ö2=0!
        
        Returns:
            List[{
                "error": str,  # –¢–æ—á–Ω–∞—è —Ü–∏—Ç–∞—Ç–∞ –æ—à–∏–±–∫–∏
                "correction": str,  # –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
                "explanation": str,  # –û–±—ä—è—Å–Ω–µ–Ω–∏–µ
                "severity": str,  # high/medium/low
                "location": str  # –ú–µ—Å—Ç–æ –≤ –ø–ª–∞–Ω–µ
            }]
        """
        
        # –ò–ó–ú–ï–ù–ï–ù–û: –°—Ç—Ä–æ–≥–∏–π system_prompt —Å —á—ë—Ç–∫–∏–º–∏ –∫—Ä–∏—Ç–µ—Ä–∏—è–º–∏ –æ—à–∏–±–æ–∫
        system_prompt = f"""–¢—ã - —Å—Ç—Ä–æ–≥–∏–π —ç–∫—Å–ø–µ—Ä—Ç –ï–ì–≠ –ø–æ –æ–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏—é. 
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –Ω–∞–π—Ç–∏ –¢–û–õ–¨–ö–û —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏.

{self.ANCHOR_EXAMPLES}

–ö–†–ò–¢–ï–†–ò–ò –î–õ–Ø –ö2=0 (—á—Ç–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è –û–®–ò–ë–ö–û–ô):
1. –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏:
   - –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–Ω—è—Ç–∏–π
   - –ò—Å–∫–∞–∂–µ–Ω–∏–µ –Ω–∞—É—á–Ω—ã—Ö –∫–æ–Ω—Ü–µ–ø—Ü–∏–π
   - –ù–µ–≤–µ—Ä–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Ñ–∞–∫—Ç—ã
   
2. –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏:
   - –õ–æ–≥–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è
   - –°–º–µ—à–∏–≤–∞–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö –ø–æ–Ω—è—Ç–∏–π
   - "–õ–∏—à–Ω–∏–µ, –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ" –ø—É–Ω–∫—Ç—ã (–∏–∑ –ø—Ä–∏–º–µ—Ä–∞ ‚Ññ2)

–ß–¢–û –ù–ï –°–ß–ò–¢–ê–ï–¢–°–Ø –û–®–ò–ë–ö–û–ô:
- –ù–µ–ø–æ–ª–Ω–æ–µ —Ä–∞—Å–∫—Ä—ã—Ç–∏–µ (—ç—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ –ö1, –Ω–µ –Ω–∞ –ö2)
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–µ—Ç–∞–ª–µ–π
- –î—Ä—É–≥–∞—è —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞, –Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ —Å—É—Ç–∏
- –°—Ç–∏–ª–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –Ω–µ–¥–æ—á—ë—Ç—ã

–ë—É–¥—å –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –°–¢–†–û–ì–ò–ú. –ï—Å–ª–∏ —Å–æ–º–Ω–µ–≤–∞–µ—à—å—Å—è - –ª—É—á—à–µ –æ—Ç–º–µ—Ç—å –∫–∞–∫ –æ—à–∏–±–∫—É."""

        etalon_info = ""
        if etalon_data:
            etalon_info = f"""
–≠—Ç–∞–ª–æ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ —Ç–µ–º–µ –¥–ª—è —Å–≤–µ—Ä–∫–∏:
{json.dumps(etalon_data.get('key_concepts', {}), ensure_ascii=False, indent=2)}
"""

        prompt = f"""–ü—Ä–æ–≤–µ—Ä—å –ø–ª–∞–Ω –Ω–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –ø–æ —Ç–µ–º–µ: "{topic}"

–ü–ª–∞–Ω —É—á–µ–Ω–∏–∫–∞:
{user_plan}
{etalon_info}

–ù–∞–π–¥–∏ –í–°–ï —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ö2=0.

–î–ª—è –∫–∞–∂–¥–æ–π –æ—à–∏–±–∫–∏ —É–∫–∞–∂–∏:
- error: –¢–û–ß–ù–ê–Ø —Ü–∏—Ç–∞—Ç–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –∏–∑ –ø–ª–∞–Ω–∞ (–Ω–µ –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä—É–π!)
- correction: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏
- explanation: –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ, –ø–æ—á–µ–º—É —ç—Ç–æ –æ—à–∏–±–∫–∞ —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –æ–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏—è
- severity: —É—Ä–æ–≤–µ–Ω—å –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏ (high/medium/low)
- location: –≥–¥–µ –≤ –ø–ª–∞–Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ø—É–Ω–∫—Ç 2, –ø–æ–¥–ø—É–Ω–∫—Ç –±")

–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è severity:
- high: –ì–†–£–ë–´–ï —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏, –∏—Å–∫–∞–∂–∞—é—â–∏–µ —Å—É—Ç—å –ø–æ–Ω—è—Ç–∏–π
  –ü—Ä–∏–º–µ—Ä: "–¥–µ–º–æ–∫—Ä–∞—Ç–∏—è - —ç—Ç–æ –≤–ª–∞—Å—Ç—å –æ–¥–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞"
  
- medium: –ù–µ—Ç–æ—á–Ω–æ—Å—Ç–∏ –≤ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞—Ö, —Å–º–µ—à–∏–≤–∞–Ω–∏–µ –ø–æ–Ω—è—Ç–∏–π
  –ü—Ä–∏–º–µ—Ä: "–ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –ø–∞—Ä—Ç–∏—è - —ç—Ç–æ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π –æ—Ä–≥–∞–Ω"
  
- low: –ù–µ–ø—Ä–∏–Ω—Ü–∏–ø–∏–∞–ª—å–Ω—ã–µ –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–∏, –Ω–µ –≤–ª–∏—è—é—â–∏–µ –Ω–∞ –ö2
  –ü—Ä–∏–º–µ—Ä: "–∏–∑–±–∏—Ä–∞—Ç–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≤—ã–±–æ—Ä—ã" (—Å–ª–∏—à–∫–æ–º –æ–±—â–æ, –Ω–æ –Ω–µ –æ—à–∏–±–∫–∞)

–í–ê–ñ–ù–û: 
- –í–æ–∑–≤—Ä–∞—â–∞–π –¢–û–õ–¨–ö–û —Ä–µ–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏, –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π
- –ï—Å–ª–∏ –æ—à–∏–±–æ–∫ –Ω–µ—Ç, –≤–µ—Ä–Ω–∏ –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ []
- –î–ª—è –ö2=0 –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –û–î–ù–û–ô –æ—à–∏–±–∫–∏ severity=high –∏–ª–∏ medium"""

        try:
            result = await self.ai_service.get_json_completion(
                prompt,
                system_prompt=system_prompt,
                temperature=0.1  # –ò–ó–ú–ï–ù–ï–ù–û: –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ (–±—ã–ª–æ –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è)
            )

            if not result or not isinstance(result, list):
                return []

            # –§–∏–ª—å—Ç—Ä—É–µ–º –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            validated_errors = []
            for error in result:
                if self._validate_error_entry(error):
                    validated_errors.append(error)
            
            # –ò–ó–ú–ï–ù–ï–ù–û: –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 3 –æ—à–∏–±–∫–∞–º–∏ (–±—ã–ª–æ 5)
            # –ï—Å–ª–∏ –Ω–∞—à–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É high/medium - —ç—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –ö2=0
            return validated_errors[:3]
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫: {e}")
            return []
    
    async def check_subpoints_quality(
        self,
        point_text: str,
        subpoints: List[str],
        topic_context: str,
        etalon_subpoints: Optional[List[str]] = None
    ) -> Dict[str, Any]:
        """
        –£–õ–£–ß–®–ï–ù–ù–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –ø–æ–¥–ø—É–Ω–∫—Ç–æ–≤
        
        –ò–ó–ú–ï–ù–ï–ù–ò–Ø:
        - –£—á—Ç–µ–Ω–æ –ø—Ä–∞–≤–∏–ª–æ "2 –ø–æ–¥–ø—É–Ω–∫—Ç–∞ –∏–Ω–æ–≥–¥–∞ –¥–æ–ø—É—Å—Ç–∏–º—ã"
        - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—Å—Ç–∏ vs –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ—Å—Ç–∏
        
        Returns:
            {
                "relevant_count": int,
                "total_quality_score": float (0-1),
                "subpoint_analysis": List[Dict],
                "improvement_suggestions": List[str],
                "matches_etalon": bool,
                "etalon_coverage": float (0-1)
            }
        """
        
        # –ò–ó–ú–ï–ù–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–∞–≤–∏–ª–æ –ø—Ä–æ 2 –ø–æ–¥–ø—É–Ω–∫—Ç–∞
        system_prompt = f"""–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ï–ì–≠ –ø–æ –æ–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏—é. 
–û—Ü–µ–Ω–∏ –∫–∞—á–µ—Å—Ç–≤–æ –ø–æ–¥–ø—É–Ω–∫—Ç–æ–≤ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—É–Ω–∫—Ç–∞ –ø–ª–∞–Ω–∞.

{self.ANCHOR_EXAMPLES}

–ü–†–ê–í–ò–õ–û –ü–†–û –ö–û–õ–ò–ß–ï–°–¢–í–û –ü–û–î–ü–£–ù–ö–¢–û–í:
- –û–±—ã—á–Ω–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –º–∏–Ω–∏–º—É–º 3 –ø–æ–¥–ø—É–Ω–∫—Ç–∞
- –ù–û: 2 –ø–æ–¥–ø—É–Ω–∫—Ç–∞ –¥–æ–ø—É—Å—Ç–∏–º—ã, –µ—Å–ª–∏ —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –Ω–∞—É–∫–∏ –±–æ–ª—å—à–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ
  –ü—Ä–∏–º–µ—Ä—ã: —É—Ä–æ–≤–Ω–∏ –ø–æ–∑–Ω–∞–Ω–∏—è (—ç–º–ø–∏—Ä–∏—á–µ—Å–∫–∏–π, —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–π), 
           –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–∏–ø—ã —Å–∏—Å—Ç–µ–º (–æ–¥–Ω–æ–ø–∞—Ä—Ç–∏–π–Ω–∞—è, –¥–≤—É—Ö–ø–∞—Ä—Ç–∏–π–Ω–∞—è)

–ë—É–¥—å —Å—Ç—Ä–æ–≥–∏–º –≤ –æ—Ü–µ–Ω–∫–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –∏ –∫–∞—á–µ—Å—Ç–≤–∞."""

        etalon_info = ""
        if etalon_subpoints:
            etalon_info = f"""
–≠—Ç–∞–ª–æ–Ω–Ω—ã–µ –ø–æ–¥–ø—É–Ω–∫—Ç—ã –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:
{self._format_subpoints(etalon_subpoints)}
"""

        # –ò–ó–ú–ï–ù–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ–ø—É—Å—Ç–∏–º–æ—Å—Ç–∏ 2 –ø–æ–¥–ø—É–Ω–∫—Ç–æ–≤
        prompt = f"""–¢–µ–º–∞ –ø–ª–∞–Ω–∞: "{topic_context}"
–ü—É–Ω–∫—Ç –ø–ª–∞–Ω–∞: "{point_text}"
–ü–æ–¥–ø—É–Ω–∫—Ç—ã —É—á–µ–Ω–∏–∫–∞ (–≤—Å–µ–≥–æ {len(subpoints)}):
{self._format_subpoints(subpoints)}
{etalon_info}

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥–ø—É–Ω–∫—Ç–∞ –æ—Ü–µ–Ω–∏:
1. –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–º—É –ø—É–Ω–∫—Ç—É (is_relevant: true/false)
2. –ö–∞—á–µ—Å—Ç–≤–æ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è (quality: 0.0-1.0)
3. –ù–∞–ª–∏—á–∏–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ (has_errors: true/false)
4. –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ—Å—Ç—å –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å (is_specific: true/false)

–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û:
5. –ï—Å–ª–∏ –ø–æ–¥–ø—É–Ω–∫—Ç–æ–≤ —Ç–æ–ª—å–∫–æ 2 - –æ—Ü–µ–Ω–∏, –¥–æ–ø—É—Å—Ç–∏–º–æ –ª–∏ —ç—Ç–æ –ø–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é?
   (two_subpoints_acceptable: true/false)
   –ü—Ä–∏—á–∏–Ω–∞, –µ—Å–ª–∏ –¥–æ–ø—É—Å—Ç–∏–º–æ (two_subpoints_reason: —Å—Ç—Ä–æ–∫–∞)

–¢–∞–∫–∂–µ –¥–∞–π –æ–±—â—É—é –æ—Ü–µ–Ω–∫—É:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –ø–æ–¥–ø—É–Ω–∫—Ç–æ–≤ (relevant_count)
- –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ (total_quality_score: 0.0-1.0)
- –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥–ø—É–Ω–∫—Ç–∞ (subpoint_analysis)
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ —É–ª—É—á—à–µ–Ω–∏—é (improvement_suggestions)
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ –Ω–∞–±–æ—Ä –ø–æ–¥–ø—É–Ω–∫—Ç–æ–≤ —ç—Ç–∞–ª–æ–Ω—É (matches_etalon: true/false)
- –°—Ç–µ–ø–µ–Ω—å –ø–æ–∫—Ä—ã—Ç–∏—è —ç—Ç–∞–ª–æ–Ω–Ω—ã—Ö –ø–æ–¥–ø—É–Ω–∫—Ç–æ–≤ (etalon_coverage: 0.0-1.0)

–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏ quality:
- 0.8-1.0: –æ—Ç–ª–∏—á–Ω—ã–π –ø–æ–¥–ø—É–Ω–∫—Ç, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω—ã–π
- 0.5-0.7: –ø—Ä–∏–µ–º–ª–µ–º—ã–π, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏
- 0.2-0.4: —Å–ª–∞–±—ã–π, —Å–ª–∏—à–∫–æ–º –æ–±—â–∏–π –∏–ª–∏ –Ω–µ—Ç–æ—á–Ω—ã–π
- 0.0-0.1: –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –≥—Ä—É–±—ã–µ –æ—à–∏–±–∫–∏"""

        try:
            result = await self.ai_service.get_json_completion(
                prompt,
                system_prompt=system_prompt,
                temperature=0.2
            )

            if not result:
                return self._default_subpoints_result(len(subpoints))

            return self._validate_subpoints_result(result, len(subpoints))
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ–¥–ø—É–Ω–∫—Ç–æ–≤: {e}")
            return self._default_subpoints_result(len(subpoints))
    
    async def compare_with_etalon(
        self,
        user_plan: str,
        parsed_user_plan: List[Tuple[str, List[str]]],
        etalon_data: Dict[str, Any],
        topic: str
    ) -> Dict[str, Any]:
        """
        –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —ç—Ç–∞–ª–æ–Ω–Ω—ã–º –ø–ª–∞–Ω–æ–º
        
        Returns:
            {
                "similarity_score": float (0-1),
                "matched_points": List[Dict],
                "missing_critical_points": List[str],
                "extra_good_points": List[str],
                "structural_match": float (0-1),
                "recommendations": List[str]
            }
        """
        system_prompt = f"""–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ï–ì–≠, —Å—Ä–∞–≤–Ω–∏–≤–∞—é—â–∏–π –ø–ª–∞–Ω —É—á–µ–Ω–∏–∫–∞ —Å —ç—Ç–∞–ª–æ–Ω–Ω—ã–º –ø–ª–∞–Ω–æ–º.
–û—Ü–µ–Ω–∏, –Ω–∞—Å–∫–æ–ª—å–∫–æ –ø–ª–∞–Ω —É—á–µ–Ω–∏–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —ç—Ç–∞–ª–æ–Ω—É –ø–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ.

{self.ANCHOR_EXAMPLES}"""

        etalon_points = etalon_data.get('points_data', [])
        etalon_formatted = self._format_full_etalon_plan(etalon_points)

        prompt = f"""–°—Ä–∞–≤–Ω–∏ –ø–ª–∞–Ω —É—á–µ–Ω–∏–∫–∞ —Å —ç—Ç–∞–ª–æ–Ω–Ω—ã–º –ø–ª–∞–Ω–æ–º –ø–æ —Ç–µ–º–µ: "{topic}"

–ü–ª–∞–Ω —É—á–µ–Ω–∏–∫–∞:
{user_plan}

–≠—Ç–∞–ª–æ–Ω–Ω—ã–π –ø–ª–∞–Ω:
{etalon_formatted}

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π:
1. –û–±—â–µ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ –ø–ª–∞–Ω–æ–≤ (similarity_score: 0.0-1.0)
2. –ö–∞–∫–∏–µ –ø—É–Ω–∫—Ç—ã —ç—Ç–∞–ª–æ–Ω–∞ –Ω–∞—à–ª–∏ –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ –≤ –ø–ª–∞–Ω–µ —É—á–µ–Ω–∏–∫–∞ (matched_points)
3. –ö–∞–∫–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ –ø—É–Ω–∫—Ç—ã —É–ø—É—â–µ–Ω—ã (missing_critical_points)
4. –ö–∞–∫–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ö–æ—Ä–æ—à–∏–µ –ø—É–Ω–∫—Ç—ã –µ—Å—Ç—å —É —É—á–µ–Ω–∏–∫–∞ (extra_good_points)
5. –ù–∞—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —ç—Ç–∞–ª–æ–Ω—É (structural_match: 0.0-1.0)
6. –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é (recommendations)

–î–ª—è matched_points —É–∫–∞–∂–∏:
- etalon_point: —Ç–µ–∫—Å—Ç –ø—É–Ω–∫—Ç–∞ –∏–∑ —ç—Ç–∞–ª–æ–Ω–∞
- user_point: —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –ø—É–Ω–∫—Ç —É—á–µ–Ω–∏–∫–∞
- match_quality: –∫–∞—á–µ—Å—Ç–≤–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è (0.0-1.0)

–í–ê–ñ–ù–û: –£—á–∏—Ç—ã–≤–∞–π –Ω–µ —Ç–æ–ª—å–∫–æ –Ω–∞–ª–∏—á–∏–µ –ø—É–Ω–∫—Ç–∞, –Ω–æ –∏ –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å.
–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ-—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π –ø—É–Ω–∫—Ç –Ω–µ –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è!"""

        try:
            result = await self.ai_service.get_json_completion(
                prompt,
                system_prompt=system_prompt,
                temperature=0.3
            )

            if not result:
                return self._default_comparison_result()

            return self._validate_comparison_result(result)
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏ —Å —ç—Ç–∞–ª–æ–Ω–æ–º: {e}")
            return self._default_comparison_result()
    
    async def generate_personalized_feedback(
        self,
        user_plan: str,
        topic: str,
        k1_score: int,
        k2_score: int,
        missed_points: List[str],
        factual_errors: Optional[List[Dict]] = None,
        comparison_result: Optional[Dict] = None
    ) -> str:
        """
        –£–õ–£–ß–®–ï–ù–ù–ê–Ø –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
        
        –ò–ó–ú–ï–ù–ï–ù–ò–Ø:
        - ‚úÖ Temperature —Å–Ω–∏–∂–µ–Ω —Å 0.7 –¥–æ 0.4
        - ‚úÖ –ë–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–π, –Ω–æ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–π —Ç–æ–Ω
        - ‚úÖ –û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ï–ì–≠
        """
        
        # –ò–ó–ú–ï–ù–ï–ù–û: –ë–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–π system_prompt
        system_prompt = f"""–¢—ã - –æ–ø—ã—Ç–Ω—ã–π –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –æ–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏—è, –≥–æ—Ç–æ–≤—è—â–∏–π –∫ –ï–ì–≠.
–î–∞–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—É—é, –Ω–æ –°–¢–†–û–ì–£–Æ –∏ –æ–±—ä–µ–∫—Ç–∏–≤–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å –ø–æ –ø–ª–∞–Ω—É —É—á–µ–Ω–∏–∫–∞.

{self.ANCHOR_EXAMPLES}

–ò—Å–ø–æ–ª—å–∑—É–π –ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Ö–æ–¥:
1. –°–ù–ê–ß–ê–õ–ê –æ—Ç–º–µ—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
2. –ó–ê–¢–ï–ú —É–∫–∞–∂–∏ –Ω–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ –ü–†–Ø–ú–û –∏ –ß–Å–¢–ö–û
3. –ó–ê–í–ï–†–®–ò –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏

–¢–æ–Ω: –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –Ω–æ —á–µ—Å—Ç–Ω—ã–π –∏ —Ç—Ä–µ–±–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π.
–ù–ï –∑–∞–≤—ã—à–∞–π –æ—Ü–µ–Ω–∫—É! –ù–ï —Å–º—è–≥—á–∞–π –ø—Ä–æ–±–ª–µ–º—ã!
–ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ —É–º–µ—Ä–µ–Ω–Ω–æ.
–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ."""

        missed_text = "\n".join([f"- {point}" for point in missed_points]) if missed_points else "–ù–µ—Ç"
        
        errors_text = ""
        if factual_errors:
            errors_text = "\n\n–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ (–≤–ª–∏—è—é—Ç –Ω–∞ –ö2):\n"
            for error in factual_errors[:3]:
                errors_text += f"- {error.get('error', '–û—à–∏–±–∫–∞')}\n"
                errors_text += f"  –ü—Ä–∞–≤–∏–ª—å–Ω–æ: {error.get('correction', '')}\n"

        comparison_text = ""
        if comparison_result:
            similarity = comparison_result.get('similarity_score', 0)
            comparison_text = f"\n\n–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —ç—Ç–∞–ª–æ–Ω—É: {int(similarity * 100)}%"

        prompt = f"""–ü–ª–∞–Ω —É—á–µ–Ω–∏–∫–∞ –ø–æ —Ç–µ–º–µ "{topic}" –ø–æ–ª—É—á–∏–ª –æ—Ü–µ–Ω–∫—É:
–ö1: {k1_score}/3 (—Ä–∞—Å–∫—Ä—ã—Ç–∏–µ —Ç–µ–º—ã –ø–æ —Å—É—â–µ—Å—Ç–≤—É)
–ö2: {k2_score}/1 (–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫)

–ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã —Ç–µ–º—ã:
{missed_text}
{errors_text}
{comparison_text}

–ü–ª–∞–Ω —É—á–µ–Ω–∏–∫–∞:
{user_plan}

–ù–∞–ø–∏—à–∏ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—É—é –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å (5-7 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π), –≤–∫–ª—é—á–∞—é—â—É—é:

1. üí™ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –ø–ª–∞–Ω–∞ (—á—Ç–æ —É–¥–∞–ª–æ—Å—å —Ö–æ—Ä–æ—à–æ) - –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –µ—Å—Ç—å
   
2. ‚ùå –ì–ª–∞–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (–±—É–¥—å –ü–†–Ø–ú–´–ú):
   - –ï—Å–ª–∏ –ö1 < 3: —á—ë—Ç–∫–æ –æ–±—ä—è—Å–Ω–∏, –ü–û–ß–ï–ú–£ –Ω–µ —Ö–≤–∞—Ç–∏–ª–æ –±–∞–ª–ª–æ–≤
   - –ï—Å–ª–∏ –ö2 = 0: —É–∫–∞–∂–∏ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏
   - –ï—Å–ª–∏ –ø—Ä–æ–ø—É—â–µ–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø—É–Ω–∫—Ç—ã: –Ω–∞–∑–æ–≤–∏ –∏—Ö
   
3. üí° 2-3 –ö–û–ù–ö–†–ï–¢–ù–´–• —Å–æ–≤–µ—Ç–∞ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é:
   - –ù–ï –æ–±—â–∏–µ —Ñ—Ä–∞–∑—ã ("–¥–æ–±–∞–≤—å—Ç–µ –¥–µ—Ç–∞–ª–µ–π")
   - –ö–û–ù–ö–†–ï–¢–ù–´–ï –¥–µ–π—Å—Ç–≤–∏—è ("–≤–∫–ª—é—á–∏—Ç–µ –ø—É–Ω–∫—Ç –ø—Ä–æ —Ñ—É–Ω–∫—Ü–∏–∏ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞ —Å –ø–æ–¥–ø—É–Ω–∫—Ç–∞–º–∏")
   
4. üìö –ß—Ç–æ –∏–∑—É—á–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø–æ —ç—Ç–æ–π —Ç–µ–º–µ (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã)

5. üéØ –ß–µ—Å—Ç–Ω–∞—è –æ—Ü–µ–Ω–∫–∞: –≥–æ—Ç–æ–≤ –ª–∏ —É—á–µ–Ω–∏–∫ –∫ —ç–∫–∑–∞–º–µ–Ω—É –ø–æ —ç—Ç–æ–π —Ç–µ–º–µ?

–í–ê–ñ–ù–û: 
- –ù–ï –ø–æ–≤—Ç–æ—Ä—è–π –±–∞–ª–ª—ã (–æ–Ω–∏ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω—ã)
- –ù–ï —Å–º—è–≥—á–∞–π –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏
- –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–π, –ß–ï–°–¢–ù–û–ô –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏"""

        try:
            result = await self.ai_service.get_completion(
                prompt,
                system_prompt=system_prompt,
                temperature=0.4  # –ò–ó–ú–ï–ù–ï–ù–û: –°–Ω–∏–∂–µ–Ω–æ —Å 0.7 –¥–æ 0.4 –¥–ª—è –º–µ–Ω—å—à–µ–π –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏
            )

            if result['success'] and result.get('text'):
                return result['text']
            
            # Fallback
            return self._generate_fallback_feedback(k1_score, k2_score)
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ feedback: {e}")
            return self._generate_fallback_feedback(k1_score, k2_score)
    
    # ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –ú–ï–¢–û–î–´ ==========
    
    def _format_etalon_points(self, points: List[Dict[str, Any]]) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–∞–ª–æ–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞"""
        formatted = []
        for i, point in enumerate(points, 1):
            if isinstance(point, dict):
                text = point.get('point_text', '')
                if point.get('is_potentially_key'):
                    formatted.append(f"{i}. {text} (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô)")
                else:
                    formatted.append(f"{i}. {text}")
        return "\n".join(formatted)
    
    def _format_full_etalon_plan(self, points: List[Dict[str, Any]]) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ —ç—Ç–∞–ª–æ–Ω–Ω–æ–≥–æ –ø–ª–∞–Ω–∞ —Å –ø–æ–¥–ø—É–Ω–∫—Ç–∞–º–∏"""
        formatted = []
        for i, point in enumerate(points, 1):
            if isinstance(point, dict):
                text = point.get('point_text', '')
                marker = " (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô)" if point.get('is_potentially_key') else ""
                formatted.append(f"{i}. {text}{marker}")
                
                subpoints = point.get('sub_points', [])
                if subpoints:
                    for j, subpoint in enumerate(subpoints):
                        formatted.append(f"   {chr(ord('–∞') + j)}) {subpoint}")
        
        return "\n".join(formatted)
    
    def _format_subpoints(self, subpoints: List[str]) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–ø—É–Ω–∫—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞"""
        return "\n".join([f"{chr(ord('–∞') + i)}) {sp}" for i, sp in enumerate(subpoints)])
    
    def _validate_relevance_result(self, result: Dict) -> Dict[str, Any]:
        """–í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏"""
        validated = {
            "is_relevant": result.get("is_relevant", True),
            "confidence": max(0.0, min(1.0, result.get("confidence", 0.5))),
            "issues": result.get("issues", [])[:5],
            "suggestions": result.get("suggestions", [])[:5],
            "missing_key_aspects": result.get("missing_key_aspects", [])[:5],
            "coverage_score": max(0.0, min(1.0, result.get("coverage_score", 0.5)))
        }
        return validated
    
    def _validate_error_entry(self, error: Dict) -> bool:
        """–í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–ø–∏—Å–∏ –æ–± –æ—à–∏–±–∫–µ"""
        required_fields = ["error", "correction", "explanation"]
        return all(field in error and error[field] for field in required_fields)
    
    def _validate_subpoints_result(self, result: Dict, subpoints_count: int) -> Dict[str, Any]:
        """–í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø—É–Ω–∫—Ç–æ–≤"""
        validated = {
            "relevant_count": min(result.get("relevant_count", subpoints_count), subpoints_count),
            "total_quality_score": max(0.0, min(1.0, result.get("total_quality_score", 0.5))),
            "subpoint_analysis": result.get("subpoint_analysis", [])[:subpoints_count],
            "improvement_suggestions": result.get("improvement_suggestions", [])[:3],
            "matches_etalon": result.get("matches_etalon", False),
            "etalon_coverage": max(0.0, min(1.0, result.get("etalon_coverage", 0.0))),
            # –ù–û–í–û–ï: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–ø—É—Å—Ç–∏–º–æ—Å—Ç–∏ 2 –ø–æ–¥–ø—É–Ω–∫—Ç–æ–≤
            "two_subpoints_acceptable": result.get("two_subpoints_acceptable", False),
            "two_subpoints_reason": result.get("two_subpoints_reason", "")
        }
        return validated
    
    def _validate_comparison_result(self, result: Dict) -> Dict[str, Any]:
        """–í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å —ç—Ç–∞–ª–æ–Ω–æ–º"""
        validated = {
            "similarity_score": max(0.0, min(1.0, result.get("similarity_score", 0.0))),
            "matched_points": result.get("matched_points", [])[:10],
            "missing_critical_points": result.get("missing_critical_points", [])[:5],
            "extra_good_points": result.get("extra_good_points", [])[:3],
            "structural_match": max(0.0, min(1.0, result.get("structural_match", 0.0))),
            "recommendations": result.get("recommendations", [])[:5]
        }
        return validated
    
    def _default_relevance_result(self) -> Dict[str, Any]:
        """–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏"""
        return {
            "is_relevant": True,
            "confidence": 0.5,
            "issues": [],
            "suggestions": [],
            "missing_key_aspects": [],
            "coverage_score": 0.7
        }
    
    def _default_subpoints_result(self, count: int) -> Dict[str, Any]:
        """–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø—É–Ω–∫—Ç–æ–≤"""
        return {
            "relevant_count": count,
            "total_quality_score": 0.7,
            "subpoint_analysis": [],
            "improvement_suggestions": [],
            "matches_etalon": False,
            "etalon_coverage": 0.0,
            "two_subpoints_acceptable": False,
            "two_subpoints_reason": ""
        }
    
    def _default_comparison_result(self) -> Dict[str, Any]:
        """–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å —ç—Ç–∞–ª–æ–Ω–æ–º"""
        return {
            "similarity_score": 0.5,
            "matched_points": [],
            "missing_critical_points": [],
            "extra_good_points": [],
            "structural_match": 0.5,
            "recommendations": []
        }
    
    def _generate_fallback_feedback(self, k1: int, k2: int) -> str:
        """
        –£–õ–£–ß–®–ï–ù–ù–´–ô –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
        
        –ò–ó–ú–ï–ù–ï–ù–û: –ë–æ–ª–µ–µ —á–µ—Å—Ç–Ω—ã–µ –∏ —Å—Ç—Ä–æ–≥–∏–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏
        """
        if k1 == 3 and k2 == 1:
            return "–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –í–∞—à –ø–ª–∞–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç —Ç–µ–º—É –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –ï–ì–≠. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ! üéâ"
        elif k1 >= 2 and k2 == 1:
            return "–•–æ—Ä–æ—à–∏–π –ø–ª–∞–Ω! –¢–µ–º–∞ –≤ —Ü–µ–ª–æ–º —Ä–∞—Å–∫—Ä—ã—Ç–∞, –Ω–æ –µ—Å—Ç—å –Ω–µ–¥–æ—á—ë—Ç—ã –≤ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏. –ò–∑—É—á–∏—Ç–µ —ç—Ç–∞–ª–æ–Ω–Ω—ã–π –ø–ª–∞–Ω –∏ –¥–æ–±–∞–≤—å—Ç–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∞—Å–ø–µ–∫—Ç—ã. üí™"
        elif k1 >= 2 and k2 == 0:
            return "–ü–ª–∞–Ω —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ –Ω–µ–ø–ª–æ—Ö, –Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏. –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏, –∏–Ω–∞—á–µ –ö2=0! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≤—Å–µ—Ö —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫. ‚ö†Ô∏è"
        elif k1 == 1 and k2 == 1:
            return "–ü–ª–∞–Ω —Ç—Ä–µ–±—É–µ—Ç —Å–µ—Ä—å—ë–∑–Ω–æ–π –¥–æ—Ä–∞–±–æ—Ç–∫–∏. –¢–µ–º–∞ —Ä–∞—Å–∫—Ä—ã—Ç–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ. –î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ –∫–ª—é—á–µ–≤—ã—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ –∏ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ø—É–Ω–∫—Ç—ã (–º–∏–Ω–∏–º—É–º 3 –ø–æ–¥–ø—É–Ω–∫—Ç–∞ –≤ –∫–∞–∂–¥–æ–º). üìö"
        else:
            return "–ü–ª–∞–Ω –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –ï–ì–≠. –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∏—Ç–µ —ç—Ç–∞–ª–æ–Ω–Ω—ã–π –ø–ª–∞–Ω, —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –∏ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏. –ù–µ —Å–¥–∞–≤–∞–π—Ç–µ—Å—å, –Ω–∞—á–Ω–∏—Ç–µ —Å –æ—Å–Ω–æ–≤! üéØ"


# ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ô –≠–ö–ó–ï–ú–ü–õ–Ø–† ==========

_ai_checker_instance: Optional[PlanAIChecker] = None


def get_ai_checker() -> PlanAIChecker:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ AI-–ø—Ä–æ–≤–µ—Ä–∫–∏"""
    global _ai_checker_instance
    
    if _ai_checker_instance is None:
        _ai_checker_instance = PlanAIChecker()
    
    return _ai_checker_instance
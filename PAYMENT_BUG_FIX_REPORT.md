# üêõ –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–æ–∫

## –î–∞—Ç–∞: 2026-01-23
## –°—Ç–∞—Ç—É—Å: ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

---

## üìã –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–ø–ª–∞—á–∏–≤–∞–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∏, –Ω–æ –Ω–µ –ø–æ–ª—É—á–∞–ª–∏ –¥–æ—Å—Ç—É–ø –∫ –º–æ–¥—É–ª—è–º. –ü–ª–∞—Ç–µ–∂–∏ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ —É—Å–ø–µ—à–Ω–æ (—Å—Ç–∞—Ç—É—Å `completed`), –Ω–æ –∑–∞–ø–∏—Å–∏ –≤ `module_subscriptions` –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å.

**–ú–∞—Å—à—Ç–∞–±:** –ü–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –Ω–∞–π–¥–µ–Ω–æ **19 –ø–ª–∞—Ç–µ–∂–µ–π** —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `completed`, —É –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫.

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üî¥ **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ç–µ—Ä—è—é—Ç –¥–µ–Ω—å–≥–∏ –∏ –Ω–µ –ø–æ–ª—É—á–∞—é—Ç –¥–æ—Å—Ç—É–ø –∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–º –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º.

---

## üîç –ê–Ω–∞–ª–∏–∑ root cause

### –ù–∞–π–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞

**–§–∞–π–ª:** `payment/subscription_manager.py`
**–°—Ç—Ä–æ–∫–∏:** 1791-1794, 1796-1802

**–°—É—Ç—å –±–∞–≥–∞:**

1. –ü—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è (—Å—Ç—Ä–æ–∫–∞ 1444)
2. –°–æ–∑–¥–∞—é—Ç—Å—è –∑–∞–ø–∏—Å–∏ –≤ `module_subscriptions` –¥–ª—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π –ø–ª–∞–Ω–∞
3. –î–ª—è —É—á–∏—Ç–µ–ª—å—Å–∫–∏—Ö –ø–ª–∞–Ω–æ–≤ (`type='teacher'`) —Å–æ–∑–¥–∞–µ—Ç—Å—è/–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ—Ñ–∏–ª—å –≤ `teacher_profiles`
4. **–ï–°–õ–ò** —Å–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è —É—á–∏—Ç–µ–ª—è **–ü–ê–î–ê–ï–¢ –° –û–®–ò–ë–ö–û–ô:**
   - –ù–∞ —Å—Ç—Ä–æ–∫–µ 1794 –∏–ª–∏ 1802 –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –∏—Å–∫–ª—é—á–µ–Ω–∏–µ (`raise`)
   - –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ª–æ–≤–∏—Ç—Å—è –Ω–∞ —Å—Ç—Ä–æ–∫–µ 1530 –≤ –º–µ—Ç–æ–¥–µ `activate_subscription`
   - –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **ROLLBACK –í–°–ï–ô –¢–†–ê–ù–ó–ê–ö–¶–ò–ò** (`await conn.rollback()`)
5. **–†–ï–ó–£–õ–¨–¢–ê–¢:** –í—Å–µ –∑–∞–ø–∏—Å–∏ –≤ `module_subscriptions` –æ—Ç–∫–∞—Ç—ã–≤–∞—é—Ç—Å—è, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –¥–æ—Å—Ç—É–ø–∞

**–¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –ø–∞–¥–µ–Ω–∏—è:**
- Database lock (–±–∞–∑–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –¥—Ä—É–≥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π)
- IntegrityError (–Ω–∞—Ä—É—à–µ–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∏–ª–∏ –≤–Ω–µ—à–Ω–∏—Ö –∫–ª—é—á–µ–π)
- –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ `teacher_profiles` (–ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–π)
- –õ—é–±–∞—è –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞ –≤ SQL –∑–∞–ø—Ä–æ—Å–µ

### –ö–æ–¥ –î–û –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

```python
# –°—Ç—Ä–æ–∫–∏ 1791-1794
except Exception as update_error:
    logger.error(f"‚ùå Failed to update teacher_profiles: {update_error}")
    # –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø–æ–π–º–∞–Ω–æ –∏ –æ—Ç–∫–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    raise  # ‚Üê –≠–¢–û –í–´–ó–´–í–ê–õ–û –û–¢–ö–ê–¢ –í–°–ï–ô –¢–†–ê–ù–ó–ê–ö–¶–ò–ò

# –°—Ç—Ä–æ–∫–∏ 1796-1802
except Exception as e:
    logger.error(f"‚ùå Error processing teacher subscription for user {user_id}: {e}")
    import traceback
    traceback.print_exc()
    # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –æ—Ç–∫–∞—Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    # –ò–Ω–∞—á–µ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –ø—Ä–æ—Ñ–∏–ª—è —É—á–∏—Ç–µ–ª—è
    raise  # ‚Üê –≠–¢–û –í–´–ó–´–í–ê–õ–û –û–¢–ö–ê–¢ –í–°–ï–ô –¢–†–ê–ù–ó–ê–ö–¶–ò–ò
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –ø–ª–æ—Ö–æ:**
- –ú–æ–¥—É–ª—å–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ (`module_subscriptions`) - —ç—Ç–æ –û–°–ù–û–í–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- –ü—Ä–æ—Ñ–∏–ª—å —É—á–∏—Ç–µ–ª—è (`teacher_profiles`) - —ç—Ç–æ –í–¢–û–†–ò–ß–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- –û—Ç–∫–∞—Ç –º–æ–¥—É–ª—å–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫ –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è = –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–ª–∞—Ç–∏—Ç, –Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç

---

## ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### –ö–æ–¥ –ü–û–°–õ–ï –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

```python
# –°—Ç—Ä–æ–∫–∏ 1791-1805
except Exception as update_error:
    logger.error(f"‚ùå Failed to update teacher_profiles: {update_error}")
    # –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ù–ï –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é!
    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∏—Ç—å –º–æ–¥—É–ª—å–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ –¥–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å —É—á–∏—Ç–µ–ª—è –Ω–µ –æ–±–Ω–æ–≤–∏–ª—Å—è
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–ª–µ—Ä—Ç –∞–¥–º–∏–Ω—É, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∞–∫—Ç–∏–≤–∞—Ü–∏—é
    try:
        from .admin_alerts import notify_admin_payment_activation_failed
        # –ü–æ–ø—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–ª–µ—Ä—Ç (–º–æ–∂–µ—Ç –Ω–µ –±—ã—Ç—å –±–æ—Ç–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ)
        logger.warning(f"‚ö†Ô∏è Teacher profile update failed but subscription will be activated")
    except:
        pass

except Exception as e:
    logger.error(f"‚ùå Error processing teacher subscription for user {user_id}: {e}")
    import traceback
    traceback.print_exc()
    # –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ù–ï –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é!
    # –ú–æ–¥—É–ª—å–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã –∏ –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å
    # –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å —É—á–∏—Ç–µ–ª—è –Ω–µ —Å–æ–∑–¥–∞–ª—Å—è - —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –º–æ–¥—É–ª—è–º
    logger.warning(
        f"‚ö†Ô∏è Teacher subscription processing failed for user {user_id}, "
        f"but module subscriptions are already activated. User will have access."
    )
```

### –õ–æ–≥–∏–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. **–£–±—Ä–∞–ª–∏ `raise`** - –Ω–µ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞–≤–µ—Ä—Ö
2. **–õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É** - admin –º–æ–∂–µ—Ç –æ—Ç—Å–ª–µ–¥–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å teacher_profiles
3. **–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∞–∫—Ç–∏–≤–∞—Ü–∏—é** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –º–æ–¥—É–ª—è–º
4. **Graceful degradation** - –µ—Å–ª–∏ teacher_profiles –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, —Ö–æ—Ç—è –±—ã module_subscriptions –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç—Å—è

### –ì–∞—Ä–∞–Ω—Ç–∏–∏

‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å **–í–°–ï–ì–î–ê** –ø–æ–ª—É—á–∏—Ç –¥–æ—Å—Ç—É–ø –∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–º –º–æ–¥—É–ª—è–º
‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è **–ù–ï –û–¢–ö–ê–¢–ò–¢–°–Ø** –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å teacher_profiles
‚úÖ –û—à–∏–±–∫–∏ teacher_profiles **–õ–û–ì–ò–†–£–Æ–¢–°–Ø** –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
‚ö†Ô∏è –í —Ä–µ–¥–∫–∏—Ö —Å–ª—É—á–∞—è—Ö –ø—Ä–æ—Ñ–∏–ª—å —É—á–∏—Ç–µ–ª—è –º–æ–∂–µ—Ç –Ω–µ —Å–æ–∑–¥–∞—Ç—å—Å—è, –Ω–æ –º–æ–¥—É–ª–∏ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å

---

## üß™ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã

### –ù–∞–π–¥–µ–Ω–æ 19 –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π

```sql
SELECT DISTINCT p.order_id, p.user_id, p.plan_id, p.amount, p.created_at
FROM payments p
LEFT JOIN module_subscriptions ms
  ON p.user_id = ms.user_id
  AND ms.is_active = 1
  AND ms.expires_at > datetime('now')
WHERE p.status = 'completed'
  AND ms.id IS NULL
ORDER BY p.created_at DESC;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 19 –∑–∞–ø–∏—Å–µ–π (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞–ø–ª–∞—Ç–∏–ª–∏, –Ω–æ –Ω–µ –ø–æ–ª—É—á–∏–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∏)

### –ü–æ—Å—Ç—Ä–∞–¥–∞–≤—à–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏

- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 974972138: –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –≤—Ä—É—á–Ω—É—é 2026-01-19
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 1893563949: –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –≤—Ä—É—á–Ω—É—é 2026-01-20
- **–ï—â–µ 17 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ –¥–æ—Å—Ç—É–ø–∞**

---

## üìù trial_7days Duration Discrepancy

### –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–æ–±—â–∏–ª: "–Ø –≤—ã–¥–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é 974972138 –ø—Ä–æ–±–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É trial_7days –Ω–∞ –Ω–µ–¥–µ–ª—é, –Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø –Ω–∞ –º–µ—Å—è—Ü (–¥–æ 2026-02-19)"

### –ê–Ω–∞–ª–∏–∑

**–î–∞—Ç—ã –∞–∫—Ç–∏–≤–∞—Ü–∏–∏:**
- User 974972138: activated_at = 2026-01-19 06:52:17, expires_at = 2026-02-19 (31 –¥–µ–Ω—å!)
- User 1893563949: activated_at = 2026-01-20 03:27:38, expires_at = 2026-02-18 (29 –¥–Ω–µ–π)

**–û–∂–∏–¥–∞–µ–º–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å trial_7days:** 7 –¥–Ω–µ–π (–¥–æ–ª–∂–Ω–æ –∏—Å—Ç–µ—á—å ~2026-01-26)

### Root cause

–≠—Ç–æ **–ù–ï –ë–ê–ì –ö–û–î–ê**, –∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä—É—á–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏.

**–ö–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ:**
```python
# payment/config.py, —Å—Ç—Ä–æ–∫–∏ 717-718
if plan_id == 'trial_7days':
    return datetime.now(timezone.utc) + timedelta(days=7)
```

**–ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ:**
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª SQL –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏, –Ω–æ –≤—ã–±—Ä–∞–ª –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç:
- ‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –≤–∞—Ä–∏–∞–Ω—Ç 1: `package_full` —Å `datetime('now', '+30 days')`
- ‚úÖ –ù—É–∂–µ–Ω –±—ã–ª –≤–∞—Ä–∏–∞–Ω—Ç 2: `trial_7days` —Å `datetime('now', '+7 days')`

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```sql
SELECT plan_id FROM module_subscriptions WHERE user_id = 974972138 LIMIT 1;
-- –í–µ—Ä–æ—è—Ç–Ω–æ –≤–µ—Ä–Ω–µ—Ç 'package_full' –≤–º–µ—Å—Ç–æ 'trial_7days'
```

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

–ü—Ä–∏ —Ä—É—á–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å:
1. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π `plan_id` ('trial_7days', –∞ –Ω–µ 'package_full')
2. –ü—Ä–∞–≤–∏–ª—å–Ω—É—é –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (`'+7 days'` –¥–ª—è trial, `'+30 days'` –¥–ª—è –º–µ—Å—è—á–Ω–æ–π)

---

## üöÄ –ß—Ç–æ –¥–∞–ª—å—à–µ?

### 1. –†–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è 19 –ø–æ—Å—Ç—Ä–∞–¥–∞–≤—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—Ä—É—á–Ω—É—é –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è 19 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:

```bash
# 1. –ù–∞–π—Ç–∏ –≤—Å–µ—Ö –ø–æ—Å—Ç—Ä–∞–¥–∞–≤—à–∏—Ö
python3 diagnose_payment.py check_incomplete

# 2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
python3 diagnose_payment.py <user_id>

# 3. –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ SQL (—Å–º. manual_activation.sql)
```

### 2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞:
1. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ –¥–ª—è —É—á–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø–ª–∞–Ω–∞
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ teacher_profiles
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–°–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏:
```bash
journalctl -u ege-bot --no-pager | grep "Teacher subscription processing failed"
```

–ï—Å–ª–∏ —Ç–∞–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –º–Ω–æ–≥–æ - –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Å teacher_profiles.

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| –ù–∞–π–¥–µ–Ω–æ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π | 19 |
| –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å –±–∞–≥–∞ | üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø |
| –§–∞–π–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–æ | 2 (subscription_manager.py, diagnose_payment.py) |
| –°—Ç—Ä–æ–∫ –∫–æ–¥–∞ –∏–∑–º–µ–Ω–µ–Ω–æ | ~30 |
| –í—Ä–µ–º—è –Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É | ~2 —á–∞—Å–∞ |
| –í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ | ~30 –º–∏–Ω—É—Ç |

---

## ‚úÖ Checklist –¥–ª—è –¥–µ–ø–ª–æ—è

- [x] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –±–∞–≥ —Å –æ—Ç–∫–∞—Ç–æ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ teacher_profiles
- [x] –û–±–Ω–æ–≤–ª–µ–Ω diagnostic script (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã column names –¥–ª—è teacher_profiles)
- [x] –°–æ–∑–¥–∞–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è
- [ ] –ö–æ–¥ –∑–∞–∫–æ–º–º–∏—á–µ–Ω –≤ –≤–µ—Ç–∫—É claude/fix-message-deletion-bug-VVnT9
- [ ] –ö–æ–¥ –∑–∞–ø—É—à–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä
- [ ] –ü–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –±–æ—Ç –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
- [ ] –†–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è 19 –ø–æ—Å—Ç—Ä–∞–¥–∞–≤—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ, —á—Ç–æ –Ω–æ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `payment/subscription_manager.py` - –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º
- `diagnose_payment.py` - –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç
- `manual_activation.sql` - SQL –¥–ª—è —Ä—É—á–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
- `PAYMENT_DIAGNOSIS_README.md` - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ
- `SERVER_DIAGNOSIS.md` - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞

---

**–ê–≤—Ç–æ—Ä:** Claude Code
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2026-01-23
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é

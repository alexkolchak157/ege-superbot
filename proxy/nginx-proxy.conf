# =============================================================
# nginx reverse proxy для Claude API (Anthropic)
#
# Альтернатива Cloudflare Worker для обхода гео-блокировки.
# Устанавливается на VPS с не-российским IP (Hetzner, DigitalOcean, etc.)
#
# Установка:
#   1. Арендуйте VPS (минимум 512MB RAM, $3-5/мес)
#      - Hetzner Cloud (Финляндия/Германия): hetzner.com
#      - DigitalOcean (Амстердам): digitalocean.com
#
#   2. Установите nginx:
#      apt update && apt install -y nginx
#
#   3. Скопируйте этот файл:
#      scp nginx-proxy.conf root@YOUR_VPS_IP:/etc/nginx/sites-available/claude-proxy
#      ln -s /etc/nginx/sites-available/claude-proxy /etc/nginx/sites-enabled/
#      rm /etc/nginx/sites-enabled/default  # убрать дефолтный сайт
#
#   4. (Опционально) Настройте SSL с Let's Encrypt:
#      apt install certbot python3-certbot-nginx
#      certbot --nginx -d claude-proxy.yourdomain.com
#
#   5. Перезапустите nginx:
#      nginx -t && systemctl restart nginx
#
#   6. В .env бота:
#      ANTHROPIC_PROXY_URL=http://YOUR_VPS_IP:8443
#      или с SSL:
#      ANTHROPIC_PROXY_URL=https://claude-proxy.yourdomain.com
#
# Преимущества перед CF Worker:
#   - Нет лимитов на размер тела запроса (CF Worker: 100MB, но буферизация)
#   - Полный контроль над таймаутами
#   - Нативный streaming без ограничений
#   - Стабильная работа с большими base64-изображениями (Vision)
# =============================================================

server {
    listen 8443;
    server_name _;

    # Максимальный размер тела запроса (base64-изображения для Vision)
    client_max_body_size 20m;

    # Таймауты для длительных запросов Claude API
    proxy_connect_timeout 30s;
    proxy_send_timeout    120s;
    proxy_read_timeout    300s;  # Claude Vision может думать до 60-120s

    # Буферизация: отключаем для streaming (SSE)
    proxy_buffering off;

    # Проксируем всё на api.anthropic.com
    location / {
        proxy_pass https://api.anthropic.com;

        # SNI — обязательно для TLS к api.anthropic.com
        proxy_ssl_server_name on;

        # Заголовки для корректной работы
        proxy_set_header Host api.anthropic.com;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Connection "";

        # HTTP/1.1 для поддержки chunked transfer и SSE
        proxy_http_version 1.1;

        # Пробрасываем заголовки авторизации
        proxy_pass_request_headers on;

        # SSE streaming: отключаем буферизацию ответа
        proxy_buffering off;
        proxy_cache off;

        # Chunked transfer encoding
        chunked_transfer_encoding on;
    }

    # Health check endpoint
    location /health {
        return 200 '{"status":"ok","proxy":"claude-api"}';
        add_header Content-Type application/json;
    }
}

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö–∞—Ä—Ç–æ—á–∫–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: var(--tg-theme-bg-color, #ffffff);
            --text: var(--tg-theme-text-color, #000000);
            --hint: var(--tg-theme-hint-color, #999999);
            --link: var(--tg-theme-link-color, #2678b6);
            --btn: var(--tg-theme-button-color, #2678b6);
            --btn-text: var(--tg-theme-button-text-color, #ffffff);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #f0f0f0);
            --card-radius: 16px;
            --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-user-select: none;
            user-select: none;
        }

        /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
        .header {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--secondary-bg);
        }
        .header-title {
            font-size: 17px;
            font-weight: 600;
        }
        .header-stats {
            font-size: 13px;
            color: var(--hint);
        }
        .xp-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: var(--secondary-bg);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
        }

        /* ‚îÄ‚îÄ Progress bar ‚îÄ‚îÄ */
        .progress-bar {
            height: 4px;
            background: var(--secondary-bg);
            position: relative;
        }
        .progress-fill {
            height: 100%;
            background: var(--btn);
            transition: width var(--transition);
            border-radius: 0 2px 2px 0;
        }

        /* ‚îÄ‚îÄ Deck selector ‚îÄ‚îÄ */
        .deck-selector {
            padding: 16px;
        }
        .deck-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .deck-item {
            background: var(--secondary-bg);
            border-radius: var(--card-radius);
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: transform 0.15s, opacity 0.15s;
            -webkit-tap-highlight-color: transparent;
        }
        .deck-item:active {
            transform: scale(0.97);
            opacity: 0.8;
        }
        .deck-icon { font-size: 28px; }
        .deck-info { flex: 1; }
        .deck-title { font-size: 15px; font-weight: 600; }
        .deck-meta { font-size: 12px; color: var(--hint); margin-top: 2px; }
        .deck-due {
            font-size: 13px;
            font-weight: 600;
            color: var(--btn);
        }

        /* ‚îÄ‚îÄ Card area ‚îÄ‚îÄ */
        .card-area {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 16px;
            min-height: calc(100vh - 100px);
        }
        .card-area.active { display: flex; }

        .card-counter {
            font-size: 14px;
            color: var(--hint);
            margin-bottom: 12px;
        }

        /* ‚îÄ‚îÄ Swipe card ‚îÄ‚îÄ */
        .card-stack {
            position: relative;
            width: 100%;
            max-width: 380px;
            height: 320px;
            perspective: 1000px;
        }

        .swipe-card {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: var(--card-radius);
            background: var(--secondary-bg);
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            cursor: grab;
            transition: transform 0.4s ease, opacity 0.4s ease;
            touch-action: pan-y;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .swipe-card.dragging {
            transition: none;
            cursor: grabbing;
        }
        .swipe-card.gone-left {
            transform: translateX(-150%) rotate(-20deg);
            opacity: 0;
        }
        .swipe-card.gone-right {
            transform: translateX(150%) rotate(20deg);
            opacity: 0;
        }

        .card-face {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            text-align: center;
        }
        .card-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--hint);
            margin-bottom: 12px;
        }
        .card-text {
            font-size: 17px;
            line-height: 1.5;
            max-height: 200px;
            overflow-y: auto;
        }
        .card-hint-btn {
            margin-top: 12px;
            font-size: 13px;
            color: var(--link);
            cursor: pointer;
            padding: 6px 12px;
        }

        /* ‚îÄ‚îÄ Flip ‚îÄ‚îÄ */
        .card-flipper {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.5s;
        }
        .card-flipper.flipped {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            border-radius: var(--card-radius);
            background: var(--secondary-bg);
        }
        .card-back {
            transform: rotateY(180deg);
        }

        /* ‚îÄ‚îÄ Swipe indicators ‚îÄ‚îÄ */
        .swipe-indicator {
            position: absolute;
            top: 16px;
            font-size: 36px;
            font-weight: 700;
            opacity: 0;
            transition: opacity 0.15s;
            pointer-events: none;
            z-index: 10;
        }
        .indicator-left {
            left: 16px;
            color: #e74c3c;
        }
        .indicator-right {
            right: 16px;
            color: #27ae60;
        }

        /* ‚îÄ‚îÄ Rating buttons ‚îÄ‚îÄ */
        .rating-buttons {
            display: none;
            width: 100%;
            max-width: 380px;
            margin-top: 16px;
            gap: 8px;
        }
        .rating-buttons.visible {
            display: grid;
            grid-template-columns: 1fr 1fr;
        }
        .rate-btn {
            padding: 14px 8px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.15s, opacity 0.15s;
            -webkit-tap-highlight-color: transparent;
        }
        .rate-btn:active { transform: scale(0.95); }
        .rate-btn[data-rating="0"] { background: #fee; color: #c0392b; }
        .rate-btn[data-rating="1"] { background: #fff3e0; color: #e67e22; }
        .rate-btn[data-rating="2"] { background: #e8f5e9; color: #27ae60; }
        .rate-btn[data-rating="3"] { background: #e3f2fd; color: #2196f3; }

        /* ‚îÄ‚îÄ Tap to flip hint ‚îÄ‚îÄ */
        .tap-hint {
            font-size: 13px;
            color: var(--hint);
            margin-top: 12px;
            text-align: center;
        }

        /* ‚îÄ‚îÄ Results screen ‚îÄ‚îÄ */
        .results-screen {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 32px 16px;
            text-align: center;
        }
        .results-screen.active { display: flex; }
        .results-emoji { font-size: 64px; margin-bottom: 16px; }
        .results-title { font-size: 22px; font-weight: 700; margin-bottom: 8px; }
        .results-subtitle { font-size: 15px; color: var(--hint); margin-bottom: 24px; }
        .results-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            width: 100%;
            max-width: 300px;
            margin-bottom: 24px;
        }
        .stat-box {
            background: var(--secondary-bg);
            border-radius: 12px;
            padding: 14px;
        }
        .stat-value { font-size: 24px; font-weight: 700; }
        .stat-label { font-size: 12px; color: var(--hint); margin-top: 2px; }
        .results-btn {
            width: 100%;
            max-width: 300px;
            padding: 14px;
            border: none;
            border-radius: 12px;
            background: var(--btn);
            color: var(--btn-text);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .results-btn.secondary {
            background: var(--secondary-bg);
            color: var(--text);
        }

        /* ‚îÄ‚îÄ Loading ‚îÄ‚îÄ */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            font-size: 15px;
            color: var(--hint);
        }
        .spinner {
            width: 32px; height: 32px;
            border: 3px solid var(--secondary-bg);
            border-top-color: var(--btn);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<!-- Loading -->
<div id="loading" class="loading">
    <div class="spinner"></div>
    –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–ª–æ–¥...
</div>

<!-- Deck selector -->
<div id="deckSelector" class="deck-selector" style="display:none">
    <div class="header">
        <div class="header-title">üÉè –ö–∞—Ä—Ç–æ—á–∫–∏</div>
        <div class="xp-badge" id="xpBadge">üí∞ 0 XP</div>
    </div>
    <div style="height:12px"></div>
    <div class="deck-list" id="deckList"></div>
</div>

<!-- Card review area -->
<div id="cardArea" class="card-area">
    <div class="header" style="width:100%;max-width:380px">
        <div class="header-title" id="deckTitle">–ö–æ–ª–æ–¥–∞</div>
        <div class="card-counter" id="cardCounter">1/20</div>
    </div>
    <div class="progress-bar" style="width:100%;max-width:380px;margin-bottom:16px">
        <div class="progress-fill" id="progressFill" style="width:0%"></div>
    </div>

    <div class="card-stack" id="cardStack">
        <div class="swipe-indicator indicator-left">üî¥</div>
        <div class="swipe-indicator indicator-right">üü¢</div>
        <div class="swipe-card" id="mainCard">
            <div class="card-flipper" id="cardFlipper">
                <div class="card-front card-face">
                    <div class="card-label">–í–û–ü–†–û–°</div>
                    <div class="card-text" id="frontText"></div>
                </div>
                <div class="card-back card-face">
                    <div class="card-label">–û–¢–í–ï–¢</div>
                    <div class="card-text" id="backText"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="tap-hint" id="tapHint">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É, —á—Ç–æ–±—ã –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å</div>

    <div class="rating-buttons" id="ratingButtons">
        <button class="rate-btn" data-rating="0">üî¥ –ù–µ –ø–æ–º–Ω—é</button>
        <button class="rate-btn" data-rating="1">üü† –°–ª–æ–∂–Ω–æ</button>
        <button class="rate-btn" data-rating="2">üü¢ –ü–æ–º–Ω—é</button>
        <button class="rate-btn" data-rating="3">üîµ –õ–µ–≥–∫–æ</button>
    </div>
</div>

<!-- Results -->
<div id="resultsScreen" class="results-screen">
    <div class="results-emoji" id="resultsEmoji">üéâ</div>
    <div class="results-title" id="resultsTitle">–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</div>
    <div class="results-subtitle" id="resultsSubtitle">–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞</div>
    <div class="results-stats">
        <div class="stat-box">
            <div class="stat-value" id="statReviewed">0</div>
            <div class="stat-label">–ü–æ–≤—Ç–æ—Ä–µ–Ω–æ</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="statCorrect">0</div>
            <div class="stat-label">–ó–Ω–∞—é —Ö–æ—Ä–æ—à–æ</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="statXP">+0</div>
            <div class="stat-label">XP –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="statInterval">0–¥</div>
            <div class="stat-label">–°—Ä. –∏–Ω—Ç–µ—Ä–≤–∞–ª</div>
        </div>
    </div>
    <button class="results-btn" id="btnReviewMore">üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –µ—â—ë</button>
    <button class="results-btn secondary" id="btnBackToDecks">üìã –ö –∫–æ–ª–æ–¥–∞–º</button>
</div>

<script>
(function() {
    'use strict';

    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.enableClosingConfirmation();

    const API_BASE = window.location.origin + '/api/flashcards';
    const initData = tg.initData;

    // State
    let decks = [];
    let currentDeck = null;
    let cards = [];
    let currentIndex = 0;
    let sessionStats = { reviewed: 0, correct: 0, xpEarned: 0, totalInterval: 0 };
    let isFlipped = false;

    // ‚îÄ‚îÄ API helpers ‚îÄ‚îÄ
    async function apiGet(path) {
        const res = await fetch(API_BASE + path, {
            headers: { 'X-Telegram-Init-Data': initData }
        });
        if (!res.ok) throw new Error(`API error: ${res.status}`);
        return res.json();
    }

    async function apiPost(path, body) {
        const res = await fetch(API_BASE + path, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Telegram-Init-Data': initData,
            },
            body: JSON.stringify(body),
        });
        if (!res.ok) throw new Error(`API error: ${res.status}`);
        return res.json();
    }

    // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
    async function init() {
        try {
            const [deckData, stats] = await Promise.all([
                apiGet('/decks'),
                apiGet('/stats'),
            ]);
            decks = deckData;
            document.getElementById('xpBadge').textContent =
                `${stats.level_icon} ${Math.round(stats.total_xp)} XP`;
            renderDecks();
            showScreen('deckSelector');
        } catch (e) {
            document.getElementById('loading').innerHTML =
                '<div style="text-align:center;padding:20px">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.<br>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</div>';
            console.error(e);
        }
    }

    function showScreen(id) {
        ['loading', 'deckSelector', 'cardArea', 'resultsScreen'].forEach(s => {
            const el = document.getElementById(s);
            if (el) {
                el.style.display = 'none';
                el.classList.remove('active');
            }
        });
        const target = document.getElementById(id);
        if (target) {
            target.style.display = id === 'deckSelector' ? 'block' : 'flex';
            target.classList.add('active');
        }
    }

    // ‚îÄ‚îÄ Deck list ‚îÄ‚îÄ
    function renderDecks() {
        const list = document.getElementById('deckList');
        list.innerHTML = '';
        decks.forEach(deck => {
            const el = document.createElement('div');
            el.className = 'deck-item';
            const pct = deck.total > 0 ? Math.round(deck.mastered / deck.total * 100) : 0;
            const due = deck.due_today;
            el.innerHTML = `
                <div class="deck-icon">${deck.icon}</div>
                <div class="deck-info">
                    <div class="deck-title">${deck.title}</div>
                    <div class="deck-meta">${deck.card_count} –∫–∞—Ä—Ç. ¬∑ ${pct}% –≤—ã—É—á–µ–Ω–æ</div>
                </div>
                <div class="deck-due">${due > 0 ? due + ' –∫ –ø–æ–≤—Ç.' : '‚úÖ'}</div>
            `;
            el.addEventListener('click', () => startReview(deck));
            list.appendChild(el);
        });
    }

    // ‚îÄ‚îÄ Start review ‚îÄ‚îÄ
    async function startReview(deck) {
        currentDeck = deck;
        currentIndex = 0;
        sessionStats = { reviewed: 0, correct: 0, xpEarned: 0, totalInterval: 0 };
        isFlipped = false;

        document.getElementById('deckTitle').textContent = deck.icon + ' ' + deck.title;
        showScreen('cardArea');

        try {
            const mode = deck.due_today > 0 ? 'due' : 'all';
            cards = await apiGet(`/decks/${deck.id}/cards?mode=${mode}&limit=30`);
            if (!cards.length) {
                tg.showAlert('–í –∫–æ–ª–æ–¥–µ –Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è');
                showScreen('deckSelector');
                return;
            }
            showCard();
        } catch (e) {
            tg.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç–æ—á–µ–∫');
            showScreen('deckSelector');
        }
    }

    // ‚îÄ‚îÄ Show card ‚îÄ‚îÄ
    function showCard() {
        if (currentIndex >= cards.length) {
            showResults();
            return;
        }

        const card = cards[currentIndex];
        document.getElementById('frontText').textContent = card.front_text;
        document.getElementById('backText').textContent = card.back_text;
        document.getElementById('cardCounter').textContent =
            `${currentIndex + 1}/${cards.length}`;

        const pct = cards.length > 0 ? (currentIndex / cards.length * 100) : 0;
        document.getElementById('progressFill').style.width = pct + '%';

        // Reset flip
        isFlipped = false;
        document.getElementById('cardFlipper').classList.remove('flipped');
        document.getElementById('ratingButtons').classList.remove('visible');
        document.getElementById('tapHint').style.display = 'block';

        // Reset card position
        const mainCard = document.getElementById('mainCard');
        mainCard.className = 'swipe-card';
        mainCard.style.transform = '';
        mainCard.style.opacity = '';

        // Haptic
        if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
    }

    // ‚îÄ‚îÄ Flip card ‚îÄ‚îÄ
    function flipCard() {
        if (isFlipped) return;
        isFlipped = true;
        document.getElementById('cardFlipper').classList.add('flipped');
        document.getElementById('ratingButtons').classList.add('visible');
        document.getElementById('tapHint').style.display = 'none';
        if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
    }

    // ‚îÄ‚îÄ Rate card ‚îÄ‚îÄ
    async function rateCard(rating) {
        const card = cards[currentIndex];
        if (!card) return;

        // Animate swipe out
        const mainCard = document.getElementById('mainCard');
        mainCard.classList.add(rating >= 2 ? 'gone-right' : 'gone-left');
        if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred(
            rating >= 2 ? 'success' : 'warning'
        );

        // Send to API (fire and forget for speed)
        apiPost(`/cards/${card.id}/review?deck_id=${currentDeck.id}`, { rating })
            .then(res => {
                sessionStats.xpEarned += res.xp_earned || 0;
                sessionStats.totalInterval += res.interval_days || 0;
            })
            .catch(e => console.error('Review error:', e));

        sessionStats.reviewed++;
        if (rating >= 2) sessionStats.correct++;

        // Next card after animation
        setTimeout(() => {
            currentIndex++;
            showCard();
        }, 350);
    }

    // ‚îÄ‚îÄ Results ‚îÄ‚îÄ
    function showResults() {
        showScreen('resultsScreen');
        const { reviewed, correct, xpEarned, totalInterval } = sessionStats;
        const pct = reviewed > 0 ? Math.round(correct / reviewed * 100) : 0;

        document.getElementById('statReviewed').textContent = reviewed;
        document.getElementById('statCorrect').textContent = correct;
        document.getElementById('statXP').textContent = '+' + Math.round(xpEarned);
        document.getElementById('statInterval').textContent =
            reviewed > 0 ? Math.round(totalInterval / reviewed) + '–¥' : '0–¥';

        if (pct >= 80) {
            document.getElementById('resultsEmoji').textContent = 'üåü';
            document.getElementById('resultsTitle').textContent = '–û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!';
            document.getElementById('resultsSubtitle').textContent = `${pct}% ‚Äî –≤—ã –æ—Ç–ª–∏—á–Ω–æ –∑–Ω–∞–µ—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª`;
        } else if (pct >= 50) {
            document.getElementById('resultsEmoji').textContent = 'üëç';
            document.getElementById('resultsTitle').textContent = '–•–æ—Ä–æ—à–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å!';
            document.getElementById('resultsSubtitle').textContent = `${pct}% ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å`;
        } else {
            document.getElementById('resultsEmoji').textContent = 'üí™';
            document.getElementById('resultsTitle').textContent = '–ù–µ —Å–¥–∞–≤–∞–π—Ç–µ—Å—å!';
            document.getElementById('resultsSubtitle').textContent = `${pct}% ‚Äî —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –ø–æ–º–æ–∂–µ—Ç`;
        }

        if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
    }

    // ‚îÄ‚îÄ Touch / swipe ‚îÄ‚îÄ
    let startX = 0, startY = 0, currentX = 0, isDragging = false;

    function onTouchStart(e) {
        if (!isFlipped) {
            flipCard();
            return;
        }
        const touch = e.touches ? e.touches[0] : e;
        startX = touch.clientX;
        startY = touch.clientY;
        isDragging = true;
        document.getElementById('mainCard').classList.add('dragging');
    }

    function onTouchMove(e) {
        if (!isDragging || !isFlipped) return;
        const touch = e.touches ? e.touches[0] : e;
        currentX = touch.clientX - startX;

        const card = document.getElementById('mainCard');
        const rotate = currentX * 0.08;
        card.style.transform = `translateX(${currentX}px) rotate(${rotate}deg)`;

        // Indicators
        const threshold = 60;
        document.querySelector('.indicator-left').style.opacity =
            currentX < -threshold ? Math.min(1, (-currentX - threshold) / 60) : 0;
        document.querySelector('.indicator-right').style.opacity =
            currentX > threshold ? Math.min(1, (currentX - threshold) / 60) : 0;
    }

    function onTouchEnd() {
        if (!isDragging) return;
        isDragging = false;

        const card = document.getElementById('mainCard');
        card.classList.remove('dragging');

        // Hide indicators
        document.querySelector('.indicator-left').style.opacity = 0;
        document.querySelector('.indicator-right').style.opacity = 0;

        const threshold = 80;
        if (currentX > threshold) {
            rateCard(2); // –ü–æ–º–Ω—é (swipe right)
        } else if (currentX < -threshold) {
            rateCard(0); // –ù–µ –ø–æ–º–Ω—é (swipe left)
        } else {
            // Snap back
            card.style.transform = '';
        }
        currentX = 0;
    }

    // ‚îÄ‚îÄ Event listeners ‚îÄ‚îÄ
    const cardStack = document.getElementById('cardStack');
    cardStack.addEventListener('touchstart', onTouchStart, { passive: true });
    cardStack.addEventListener('touchmove', onTouchMove, { passive: true });
    cardStack.addEventListener('touchend', onTouchEnd);
    cardStack.addEventListener('mousedown', onTouchStart);
    document.addEventListener('mousemove', onTouchMove);
    document.addEventListener('mouseup', onTouchEnd);

    // Click to flip (no drag)
    cardStack.addEventListener('click', (e) => {
        if (Math.abs(currentX) < 5 && !isFlipped) flipCard();
    });

    // Rating buttons
    document.querySelectorAll('.rate-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const rating = parseInt(btn.dataset.rating);
            rateCard(rating);
        });
    });

    // Results buttons
    document.getElementById('btnReviewMore').addEventListener('click', () => {
        if (currentDeck) startReview(currentDeck);
    });
    document.getElementById('btnBackToDecks').addEventListener('click', async () => {
        try {
            const [deckData, stats] = await Promise.all([
                apiGet('/decks'),
                apiGet('/stats'),
            ]);
            decks = deckData;
            document.getElementById('xpBadge').textContent =
                `${stats.level_icon} ${Math.round(stats.total_xp)} XP`;
            renderDecks();
        } catch(e) {}
        showScreen('deckSelector');
    });

    // Back button
    tg.BackButton.onClick(() => {
        if (document.getElementById('resultsScreen').classList.contains('active') ||
            document.getElementById('cardArea').classList.contains('active')) {
            showScreen('deckSelector');
            tg.BackButton.hide();
        } else {
            tg.close();
        }
    });

    // Show back button when in review
    const observer = new MutationObserver(() => {
        const inDecks = document.getElementById('deckSelector').style.display !== 'none';
        if (inDecks) tg.BackButton.hide();
        else tg.BackButton.show();
    });
    observer.observe(document.getElementById('deckSelector'), { attributes: true });

    // ‚îÄ‚îÄ Start ‚îÄ‚îÄ
    init();

})();
</script>
</body>
</html>

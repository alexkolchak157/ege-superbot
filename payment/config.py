# payment/config.py - –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å –¥–≤—É–º—è —Ç–∞—Ä–∏—Ñ–∞–º–∏
"""–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–¥—É–ª—è –æ–ø–ª–∞—Ç—ã —Å –ø—Ä–æ–±–Ω—ã–º –ø–µ—Ä–∏–æ–¥–æ–º –∏ –ø–æ–ª–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–æ–π."""
import os
import logging
from decimal import Decimal
from datetime import datetime, timedelta, timezone
from typing import Dict, Any, List, Optional
from dotenv import load_dotenv

load_dotenv()

logger = logging.getLogger(__name__)

# ==================== TINKOFF SETTINGS ====================
TINKOFF_TERMINAL_KEY = os.getenv('TINKOFF_TERMINAL_KEY')
TINKOFF_SECRET_KEY = os.getenv('TINKOFF_SECRET_KEY')
TINKOFF_API_URL = 'https://securepay.tinkoff.ru/v2/'

# ==================== WEBHOOK SETTINGS ====================
WEBHOOK_BASE_URL = os.getenv('WEBHOOK_BASE_URL', 'https://your-domain.com')
WEBHOOK_PATH = '/payment/webhook'
WEBHOOK_HOST = '0.0.0.0'
WEBHOOK_PORT = 8080
# –ò—Å–ø–æ–ª—å–∑—É–µ–º WEBHOOK_BASE_URL –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ —Ö–∞—Ä–¥–∫–æ–¥–∞
WEBHOOK_URL = f"{WEBHOOK_BASE_URL}{WEBHOOK_PATH}"

# ==================== ADMIN SETTINGS ====================
PAYMENT_ADMIN_CHAT_ID = int(os.getenv('PAYMENT_ADMIN_CHAT_ID', '0'))

# –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π DATABASE_FILE –∏–∑ core.config
# –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤ –∫–∞–∂–¥–æ–º –º–æ–¥—É–ª–µ
try:
    from core.config import DATABASE_FILE
    DATABASE_PATH = DATABASE_FILE  # –ê–ª–∏–∞—Å –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
except ImportError:
    # Fallback –µ—Å–ª–∏ core.config –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
    DATABASE_PATH = os.getenv('DATABASE_FILE', 'quiz_async.db')
    DATABASE_FILE = DATABASE_PATH
    logger.warning("Could not import DATABASE_FILE from core.config, using fallback")

# ==================== SUBSCRIPTION MODE ====================
SUBSCRIPTION_MODE = 'modular'  # –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã
FREE_MODULES = ['test_part', 'personal_cabinet', 'teacher_mode']  # –ú–æ–¥—É–ª–∏ –í–°–ï–ì–î–ê –±–µ—Å–ø–ª–∞—Ç–Ω—ã

# –ú–æ–¥—É–ª–∏ —Å freemium –¥–æ—Å—Ç—É–ø–æ–º (3 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö AI-–ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ –¥–µ–Ω—å)
FREEMIUM_MODULES = ['task19', 'task20', 'task24', 'task25']

# ==================== CONFIG VALIDATION ====================

class ConfigValidationError(Exception):
    """–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏."""
    pass


def validate_config() -> None:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ.

    Raises:
        ConfigValidationError: –ï—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    """
    errors = []
    warnings = []

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ø–∞—Ä–∞–º–µ—Ç—Ä—ã Tinkoff
    if not TINKOFF_TERMINAL_KEY:
        errors.append("TINKOFF_TERMINAL_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    elif len(TINKOFF_TERMINAL_KEY) < 10:
        warnings.append("TINKOFF_TERMINAL_KEY –≤—ã–≥–ª—è–¥–∏—Ç –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–æ—Ç–∫–∏–º")

    if not TINKOFF_SECRET_KEY:
        errors.append("TINKOFF_SECRET_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    elif len(TINKOFF_SECRET_KEY) < 10:
        warnings.append("TINKOFF_SECRET_KEY –≤—ã–≥–ª—è–¥–∏—Ç –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–æ—Ç–∫–∏–º")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º WEBHOOK_BASE_URL
    if WEBHOOK_BASE_URL == 'https://your-domain.com':
        errors.append("WEBHOOK_BASE_URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)")
    elif not WEBHOOK_BASE_URL.startswith('https://'):
        errors.append("WEBHOOK_BASE_URL –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTTPS –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º PAYMENT_ADMIN_CHAT_ID
    if PAYMENT_ADMIN_CHAT_ID == 0:
        warnings.append("PAYMENT_ADMIN_CHAT_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω - –∞–¥–º–∏–Ω –Ω–µ –±—É–¥–µ—Ç –ø–æ–ª—É—á–∞—Ç—å –∞–ª–µ—Ä—Ç—ã –æ –ø–ª–∞—Ç–µ–∂–∞—Ö")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º DATABASE_FILE
    if not DATABASE_FILE:
        errors.append("DATABASE_FILE –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")

    # –õ–æ–≥–∏—Ä—É–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
    for warning in warnings:
        logger.warning(f"‚ö†Ô∏è  Config warning: {warning}")

    # –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ - –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
    if errors:
        error_msg = "–û—à–∏–±–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ payment –º–æ–¥—É–ª—è:\n" + "\n".join(f"  ‚ùå {e}" for e in errors)
        logger.error(error_msg)
        raise ConfigValidationError(error_msg)

    logger.info("‚úÖ Payment config validation passed")


def get_config_status() -> Dict[str, Any]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏.

    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–±–µ–∑ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
    """
    return {
        'tinkoff_configured': bool(TINKOFF_TERMINAL_KEY and TINKOFF_SECRET_KEY),
        'webhook_configured': WEBHOOK_BASE_URL != 'https://your-domain.com',
        'webhook_https': WEBHOOK_BASE_URL.startswith('https://') if WEBHOOK_BASE_URL else False,
        'admin_alerts_enabled': PAYMENT_ADMIN_CHAT_ID != 0,
        'subscription_mode': SUBSCRIPTION_MODE,
        'database_file': DATABASE_FILE,
        'free_modules': FREE_MODULES,
        'freemium_modules': FREEMIUM_MODULES
    }


# –í–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –º–æ–¥—É–ª—è (–º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –¥–ª—è —Ç–µ—Å—Ç–æ–≤)
if os.getenv('SKIP_PAYMENT_CONFIG_VALIDATION') != '1':
    try:
        validate_config()
    except ConfigValidationError as e:
        logger.error(f"Payment module configuration error: {e}")
        logger.error("Payment features will be DISABLED. Fix config and restart.")
        # –ù–ï –ø–∞–¥–∞–µ–º, —á—Ç–æ–±—ã –±–æ—Ç –º–æ–≥ –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è –±–µ–∑ –ø–ª–∞—Ç–µ–∂–µ–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        # –Ω–æ –ª–æ–≥–∏—Ä—É–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –æ—à–∏–±–∫—É

logger.info(f"Payment module loaded with SUBSCRIPTION_MODE = {SUBSCRIPTION_MODE}")
logger.info(f"Free modules: {FREE_MODULES}")
logger.info(f"Freemium modules: {FREEMIUM_MODULES}")

# ==================== –£–ü–†–û–©–ï–ù–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –ü–û–î–ü–ò–°–û–ö ====================
MODULE_PLANS = {
    # –ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥
    'trial_7days': {
        'name': 'üéÅ –ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥',
        'description': '–ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –Ω–∞ 7 –¥–Ω–µ–π –∑–∞ 1 —Ä—É–±–ª—å',
        'detailed_description': [
            '‚Ä¢ –î–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –∑–∞–¥–∞–Ω–∏—è–º –≤—Ç–æ—Ä–æ–π —á–∞—Å—Ç–∏',
            '‚Ä¢ –ò–ò-–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞',
            '‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏',
            '‚Ä¢ –ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –Ω–∞ 7 –¥–Ω–µ–π'
        ],
        'price_rub': 1,
        'duration_days': 7,
        'modules': ['test_part', 'task19', 'task20', 'task24', 'task25'],
        'type': 'trial',
        'features': [
            '‚úÖ –í—Å–µ –∑–∞–¥–∞–Ω–∏—è –≤—Ç–æ—Ä–æ–π —á–∞—Å—Ç–∏',
            '‚úÖ –ò–ò-–ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤',
            '‚úÖ –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –Ω–∞ –Ω–µ–¥–µ–ª—é',
            'üí° –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞'
        ]
    },
    
    # –ü–æ–ª–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
    'package_full': {
        'name': 'üëë –ü–æ–ª–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞',
        'description': '–ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –∑–∞–¥–∞–Ω–∏—è–º',
        'price_rub': 249,
        'duration_days': 30,
        'modules': ['test_part', 'task19', 'task20', 'task24', 'task25'],
        'type': 'package',
        'features': [
            '‚úÖ –í—Å–µ –∑–∞–¥–∞–Ω–∏—è –≤—Ç–æ—Ä–æ–π —á–∞—Å—Ç–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ò–ò',
            '‚úÖ –ó–∞–¥–∞–Ω–∏–µ 19 ‚Äî –ü—Ä–∏–º–µ—Ä—ã –∏ –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏',
            '‚úÖ –ó–∞–¥–∞–Ω–∏–µ 20 ‚Äî –†–∞–±–æ—Ç–∞ —Å —Ç–µ–∫—Å—Ç–æ–º',
            '‚úÖ –ó–∞–¥–∞–Ω–∏–µ 24 ‚Äî –°–ª–æ–∂–Ω—ã–π –ø–ª–∞–Ω',
            '‚úÖ –ó–∞–¥–∞–Ω–∏–µ 25 ‚Äî –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏',
            'üí° –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –±–∞–ª–ª—ã –Ω–∞ –ï–ì–≠!'
        ],
        'detailed_description': [
            '‚Ä¢ –ó–∞–¥–∞–Ω–∏–µ 19: –ù–∞—É—á–∏—Å—å –ø–æ–¥–±–∏—Ä–∞—Ç—å –∏–¥–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∫ –ª—é–±–æ–π —Ç–µ–æ—Ä–∏–∏',
            '‚Ä¢ –ó–∞–¥–∞–Ω–∏–µ 20: –ü–∏—à–∏ –∞—Ä–≥—É–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ü–µ–Ω—è—Ç –Ω–∞ –º–∞–∫—Å–∏–º—É–º',
            '‚Ä¢ –ó–∞–¥–∞–Ω–∏–µ 24: –°–æ—Å—Ç–∞–≤–ª—è–π –ø–ª–∞–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –∑–∞–≤–∞–ª–∏—Ç—å',
            '‚Ä¢ –ó–∞–¥–∞–Ω–∏–µ 25: –û–±–æ—Å–Ω–æ–≤—ã–≤–∞–π —Ç–∞–∫, —á—Ç–æ–±—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ—Å—Ç–∞–≤–∏–ª 6/6',
            '‚Ä¢ –ò–ò –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ –∫–∞–∫ —Å—Ç—Ä–æ–≥–∏–π —ç–∫—Å–ø–µ—Ä—Ç –§–ò–ü–ò',
            '‚Ä¢ –°–º–æ—Ç—Ä–∏ —ç—Ç–∞–ª–æ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –∏ –ø–æ–≤—Ç–æ—Ä—è–π —É—Å–ø–µ—Ö'
        ]
    },

    # ==================== –ü–û–î–ü–ò–°–ö–ò –î–õ–Ø –£–ß–ò–¢–ï–õ–ï–ô ====================
    # –í–†–ï–ú–ï–ù–ù–û –°–ö–†–´–¢–û: –†–µ–∂–∏–º —É—á–∏—Ç–µ–ª—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ

    # # –ü–æ–¥–ø–∏—Å–∫–∞ —É—á–µ–Ω–∏–∫–∞ —Å–æ —Å–∫–∏–¥–∫–æ–π –æ—Ç —É—á–∏—Ç–µ–ª—è
    # 'student_with_teacher': {
    #     'name': 'üéì –ü–æ–¥–ø–∏—Å–∫–∞ —É—á–µ–Ω–∏–∫–∞',
    #     'description': '–°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –¥–ª—è —É—á–µ–Ω–∏–∫–æ–≤ –æ—Ç —É—á–∏—Ç–µ–ª—è',
    #     'price_rub': 149,
    #     'duration_days': 30,
    #     'modules': ['test_part', 'task19', 'task20', 'task24', 'task25'],
    #     'type': 'student',
    #     'features': [
    #         '‚úÖ –í—Å–µ –∑–∞–¥–∞–Ω–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ò–ò',
    #         '‚úÖ –°–∫–∏–¥–∫–∞ 100‚ÇΩ –æ—Ç —É—á–∏—Ç–µ–ª—è',
    #         '‚úÖ –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è –æ—Ç —É—á–∏—Ç–µ–ª—è',
    #         '‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞',
    #         'üí∞ –í—ã–≥–æ–¥–Ω–æ: 149‚ÇΩ –≤–º–µ—Å—Ç–æ 249‚ÇΩ'
    #     ],
    #     'detailed_description': [
    #         '‚Ä¢ –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –∑–∞–¥–∞–Ω–∏—è–º –≤—Ç–æ—Ä–æ–π —á–∞—Å—Ç–∏',
    #         '‚Ä¢ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π –æ—Ç —É—á–∏—Ç–µ–ª—è',
    #         '‚Ä¢ –£—á–∏—Ç–µ–ª—å –≤–∏–¥–∏—Ç –≤–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ —Å–ª–∞–±—ã–µ –º–µ—Å—Ç–∞',
    #         '‚Ä¢ –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ ‚Äî —ç–∫–æ–Ω–æ–º–∏—è 100 —Ä—É–±–ª–µ–π',
    #         '‚Ä¢ –ò–ò –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç –∫–∞–∫ —ç–∫—Å–ø–µ—Ä—Ç –ï–ì–≠'
    #     ]
    # },

    # # –ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –¥–ª—è —É—á–∏—Ç–µ–ª–µ–π - 7 –¥–Ω–µ–π –∑–∞ 1‚ÇΩ
    # 'teacher_trial_7days': {
    #     'name': 'üéÅ –ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –¥–ª—è —É—á–∏—Ç–µ–ª—è',
    #     'description': '–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞ 1 —Ä—É–±–ª—å',
    #     'price_rub': 1,
    #     'duration_days': 7,
    #     'modules': ['test_part', 'task19', 'task20', 'task24', 'task25'],
    #     'type': 'teacher',
    #     'max_students': 3,
    #     'features': [
    #         '‚úÖ –î–æ 3 —É—á–µ–Ω–∏–∫–æ–≤',
    #         '‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π',
    #         '‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞',
    #         '‚úÖ –ë–∞–∑–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
    #         '‚úÖ 7 –¥–Ω–µ–π –ø–æ–ª–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞',
    #         'üéÅ –í—Å–µ–≥–æ 1 —Ä—É–±–ª—å!'
    #     ],
    #     'detailed_description': [
    #         '‚Ä¢ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–µ–∂–∏–º–∞ —É—á–∏—Ç–µ–ª—è',
    #         '‚Ä¢ –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –¥–æ 3 —É—á–µ–Ω–∏–∫–æ–≤ –ø–æ –≤–∞—à–µ–º—É –∫–æ–¥—É',
    #         '‚Ä¢ –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –¥–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è –∏–∑ –≥–æ—Ç–æ–≤—ã—Ö —Ç–µ–º',
    #         '‚Ä¢ –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å —É—á–µ–Ω–∏–∫–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏',
    #         '‚Ä¢ 7 –¥–Ω–µ–π –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞',
    #         '‚Ä¢ –ü–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç—Ä–∏–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ç–∞—Ä–∏—Ñ'
    #     ]
    # },

    # # –£—á–∏—Ç–µ–ª—å Basic - –¥–æ 10 —É—á–µ–Ω–∏–∫–æ–≤
    # 'teacher_basic': {
    #     'name': 'üë®‚Äçüè´ –£—á–∏—Ç–µ–ª—å Basic',
    #     'description': '–î–ª—è —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–æ–≤ –¥–æ 10 —É—á–µ–Ω–∏–∫–æ–≤',
    #     'price_rub': 249,
    #     'duration_days': 30,
    #     'modules': ['test_part', 'task19', 'task20', 'task24', 'task25'],
    #     'type': 'teacher',
    #     'max_students': 10,
    #     'features': [
    #         '‚úÖ –î–æ 10 —É—á–µ–Ω–∏–∫–æ–≤',
    #         '‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π',
    #         '‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —É—á–µ–Ω–∏–∫–æ–≤',
    #         '‚úÖ –ë–∞–∑–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
    #         '‚úÖ –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ–¥ –¥–ª—è —É—á–µ–Ω–∏–∫–æ–≤',
    #         'üí° –î–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–æ–≤'
    #     ],
    #     'detailed_description': [
    #         '‚Ä¢ –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –¥–æ 10 —É—á–µ–Ω–∏–∫–æ–≤ –ø–æ –≤–∞—à–µ–º—É –∫–æ–¥—É',
    #         '‚Ä¢ –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –¥–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è –∏–∑ –≥–æ—Ç–æ–≤—ã—Ö —Ç–µ–º',
    #         '‚Ä¢ –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥–æ–≥–æ —É—á–µ–Ω–∏–∫–∞',
    #         '‚Ä¢ –°–º–æ—Ç—Ä–∏—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –∑–∞–¥–∞–Ω–∏—è–º',
    #         '‚Ä¢ –í–∞—à–∏ —É—á–µ–Ω–∏–∫–∏ –ø–æ–ª—É—á–∞—é—Ç —Å–∫–∏–¥–∫—É –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É',
    #         '‚Ä¢ –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–º –º–æ–¥—É–ª—è–º'
    #     ]
    # },

    # # –£—á–∏—Ç–µ–ª—å Standard - –¥–æ 20 —É—á–µ–Ω–∏–∫–æ–≤
    # 'teacher_standard': {
    #     'name': 'üë®‚Äçüè´ –£—á–∏—Ç–µ–ª—å Standard',
    #     'description': '–î–ª—è –æ–ø—ã—Ç–Ω—ã—Ö —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–æ–≤ –¥–æ 20 —É—á–µ–Ω–∏–∫–æ–≤',
    #     'price_rub': 449,
    #     'duration_days': 30,
    #     'modules': ['test_part', 'task19', 'task20', 'task24', 'task25'],
    #     'type': 'teacher',
    #     'max_students': 20,
    #     'features': [
    #         '‚úÖ –î–æ 20 —É—á–µ–Ω–∏–∫–æ–≤',
    #         '‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π',
    #         '‚úÖ –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —É—á–µ–Ω–∏–∫–∞–º',
    #         '‚úÖ –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç —É—Å–ø–µ—Ö–æ–≤',
    #         '‚úÖ –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ–¥ –¥–ª—è —É—á–µ–Ω–∏–∫–æ–≤',
    #         '‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞',
    #         'üíé –î–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–≤'
    #     ],
    #     'detailed_description': [
    #         '‚Ä¢ –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –¥–æ 20 —É—á–µ–Ω–∏–∫–æ–≤ –ø–æ –≤–∞—à–µ–º—É –∫–æ–¥—É',
    #         '‚Ä¢ –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∑–∞–¥–∞–Ω–∏—è –∏–∑ –≥–æ—Ç–æ–≤—ã—Ö —Ç–µ–º',
    #         '‚Ä¢ –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–ª–∞–±—ã—Ö –º–µ—Å—Ç —É—á–µ–Ω–∏–∫–æ–≤',
    #         '‚Ä¢ –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ',
    #         '‚Ä¢ –í–∞—à–∏ —É—á–µ–Ω–∏–∫–∏ –ø–æ–ª—É—á–∞—é—Ç —Å–∫–∏–¥–∫—É –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É',
    #         '‚Ä¢ –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–º –º–æ–¥—É–ª—è–º',
    #         '‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞'
    #     ]
    # },

    # # –£—á–∏—Ç–µ–ª—å Premium - –±–µ–∑–ª–∏–º–∏—Ç —É—á–µ–Ω–∏–∫–æ–≤
    # 'teacher_premium': {
    #     'name': 'üë®‚Äçüè´ –£—á–∏—Ç–µ–ª—å Premium',
    #     'description': '–ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ –¥–ª—è —à–∫–æ–ª –∏ –∫—É—Ä—Å–æ–≤',
    #     'price_rub': 699,
    #     'duration_days': 30,
    #     'modules': ['test_part', 'task19', 'task20', 'task24', 'task25'],
    #     'type': 'teacher',
    #     'max_students': -1,  # –ë–µ–∑–ª–∏–º–∏—Ç
    #     'features': [
    #         '‚úÖ –ë–µ–∑–ª–∏–º–∏—Ç —É—á–µ–Ω–∏–∫–æ–≤',
    #         '‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –ª—é–±—ã—Ö –∑–∞–¥–∞–Ω–∏–π',
    #         '‚úÖ –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞',
    #         '‚úÖ –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç',
    #         '‚úÖ –î–∞—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏ —É—á–µ–Ω–∏–∫–∞–º',
    #         '‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤',
    #         '‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞',
    #         'üî• –î–ª—è —à–∫–æ–ª –∏ –∫—É—Ä—Å–æ–≤'
    #     ],
    #     'detailed_description': [
    #         '‚Ä¢ –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–µ–Ω–∏–∫–æ–≤',
    #         '‚Ä¢ –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –ª—é–±—ã–µ –¥–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è',
    #         '‚Ä¢ –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏',
    #         '‚Ä¢ –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –≤—Å–µ–º —É—á–µ–Ω–∏–∫–∞–º',
    #         '‚Ä¢ –î–∞—Ä–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫–∏ –ª—É—á—à–∏–º —É—á–µ–Ω–∏–∫–∞–º',
    #         '‚Ä¢ –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã –¥–ª—è —Å–≤–æ–∏—Ö —É—á–µ–Ω–∏–∫–æ–≤',
    #         '‚Ä¢ –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–º –º–æ–¥—É–ª—è–º',
    #         '‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞'
    #     ]
    # }
}

# ==================== –°–ö–ò–î–ö–ò –ó–ê –î–õ–ò–¢–ï–õ–¨–ù–û–°–¢–¨ ====================
# –†–∞—Å—á–µ—Ç:
# 1 –º–µ—Å—è—Ü: 249‚ÇΩ (–±–µ–∑ —Å–∫–∏–¥–∫–∏)
# 3 –º–µ—Å—è—Ü–∞: 672‚ÇΩ (10% —Å–∫–∏–¥–∫–∞ = 224‚ÇΩ/–º–µ—Å, —ç–∫–æ–Ω–æ–º–∏—è 75‚ÇΩ)
# 6 –º–µ—Å—è—Ü–µ–≤: 1270‚ÇΩ (15% —Å–∫–∏–¥–∫–∞ = 212‚ÇΩ/–º–µ—Å, —ç–∫–æ–Ω–æ–º–∏—è 224‚ÇΩ)

DURATION_DISCOUNTS = {
    1: {
        'multiplier': 1.0,  # –ë–µ–∑ —Å–∫–∏–¥–∫–∏
        'label': '1 –º–µ—Å—è—Ü',
        'discount_percent': 0,
        'badge': ''
    },
    3: {
        'multiplier': 2.7,  # 672‚ÇΩ –≤–º–µ—Å—Ç–æ 747‚ÇΩ (—Å–∫–∏–¥–∫–∞ 10%)
        'label': '3 –º–µ—Å—è—Ü–∞',
        'discount_percent': 10,
        'badge': 'üí∞ –í—ã–≥–æ–¥–∞',
        'savings': 75  # –≠–∫–æ–Ω–æ–º–∏—è –≤ —Ä—É–±–ª—è—Ö
    },
    6: {
        'multiplier': 5.1,  # 1270‚ÇΩ –≤–º–µ—Å—Ç–æ 1494‚ÇΩ (—Å–∫–∏–¥–∫–∞ 15%)
        'label': '6 –º–µ—Å—è—Ü–µ–≤',
        'discount_percent': 15,
        'badge': 'üî• –õ—É—á—à–∞—è —Ü–µ–Ω–∞',
        'savings': 224  # –≠–∫–æ–Ω–æ–º–∏—è –≤ —Ä—É–±–ª—è—Ö
    }
}

# ==================== –í–´–ë–û–† –ê–ö–¢–ò–í–ù–û–ô –°–ò–°–¢–ï–ú–´ ====================
SUBSCRIPTION_PLANS = MODULE_PLANS
logger.info(f"Using simplified MODULE_PLANS with {len(MODULE_PLANS)} plans")
logger.info(f"Available plans: {list(SUBSCRIPTION_PLANS.keys())}")

# ==================== –û–ü–ò–°–ê–ù–ò–Ø –ú–û–î–£–õ–ï–ô –î–õ–Ø UI ====================
MODULE_DESCRIPTIONS = {
    'test_part': {
        'emoji': 'üìù',
        'short_name': '–¢–µ—Å—Ç–æ–≤–∞—è —á–∞—Å—Ç—å',
        'full_name': '–ó–∞–¥–∞–Ω–∏—è 1-16 (—Ç–µ—Å—Ç–æ–≤–∞—è —á–∞—Å—Ç—å)',
        'description': '–í—Å–µ –∑–∞–¥–∞–Ω–∏—è –ø–µ—Ä–≤–æ–π —á–∞—Å—Ç–∏ –ï–ì–≠ —Å –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–æ–π',
        'features': [
            '–ë–æ–ª–µ–µ 1000 –∑–∞–¥–∞–Ω–∏–π',
            '–í—Å–µ —Ç–µ–º—ã –∫–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞',
            '–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞',
            '–ü–æ–¥—Ä–æ–±–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è'
        ],
        'is_free': True
    },
    'task19': {
        'emoji': 'üéØ',
        'short_name': '–ó–∞–¥–∞–Ω–∏–µ 19',
        'full_name': '–ó–∞–¥–∞–Ω–∏–µ 19 ‚Äî –ü—Ä–∏–º–µ—Ä—ã –∏ –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏',
        'description': '–ù–∞—É—á–∏—Å—å –ø–æ–¥–±–∏—Ä–∞—Ç—å —É–±–µ–¥–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∫ –ª—é–±–æ–π —Ç–µ–æ—Ä–∏–∏',
        'features': [
            '–£—á–∏—Å—å –Ω–∞ –ª—É—á—à–∏—Ö –ø—Ä–∏–º–µ—Ä–∞—Ö',
            '–ò–ò –æ—Ü–µ–Ω–∏—Ç —Ç–≤–æ–∏ –ø—Ä–∏–º–µ—Ä—ã',
            '–ë–∞–∑–∞ –≥–æ—Ç–æ–≤—ã—Ö —Ä–µ—à–µ–Ω–∏–π',
            '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é'
        ],
        'is_free': False
    },
    'task20': {
        'emoji': 'üìñ',
        'short_name': '–ó–∞–¥–∞–Ω–∏–µ 20',
        'full_name': '–ó–∞–¥–∞–Ω–∏–µ 20 ‚Äî –†–∞–±–æ—Ç–∞ —Å —Ç–µ–∫—Å—Ç–æ–º',
        'description': '–§–æ—Ä–º—É–ª–∏—Ä—É–π –∞—Ä–≥—É–º–µ–Ω—Ç—ã, –∑–∞ –∫–æ—Ç–æ—Ä—ã–µ –¥–∞—é—Ç –º–∞–∫—Å–∏–º—É–º –±–∞–ª–ª–æ–≤',
        'features': [
            '–†–∞–∑–±–∏—Ä–∞–π —Ç–µ–∫—Å—Ç—ã –∫–∞–∫ –ø—Ä–æ—Ñ–∏',
            '–ü–∏—à–∏ —É–±–µ–¥–∏—Ç–µ–ª—å–Ω—ã–µ —Å—É–∂–¥–µ–Ω–∏—è',
            '–ò—Å–ø–æ–ª—å–∑—É–π –≥–æ—Ç–æ–≤—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏',
            '–ò–ò –ø—Ä–æ–≤–µ—Ä–∏—Ç —Ç–≤–æ—é –ª–æ–≥–∏–∫—É'
        ],
        'is_free': False
    },
    'task24': {
        'emoji': 'üíé',
        'short_name': '–ó–∞–¥–∞–Ω–∏–µ 24',
        'full_name': '–ó–∞–¥–∞–Ω–∏–µ 24 ‚Äî –°–ª–æ–∂–Ω—ã–π –ø–ª–∞–Ω',
        'description': '–°–æ—Å—Ç–∞–≤–ª—è–π –ø–ª–∞–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ —ç–∫—Å–ø–µ—Ä—Ç –Ω–µ —Å–º–æ–∂–µ—Ç –∑–∞–≤–∞–ª–∏—Ç—å',
        'features': [
            '–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç—ã –∫–∞–∫ –ø—Ä–æ—Ñ–∏',
            '–ò–ò –ø—Ä–æ–≤–µ—Ä–∏—Ç –∫–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç',
            '–°–º–æ—Ç—Ä–∏ —ç—Ç–∞–ª–æ–Ω–Ω—ã–µ –ø–ª–∞–Ω—ã',
            '–ü–æ–ª—É—á–∞–π –æ—Ü–µ–Ω–∫—É –∫–∞–∫ –Ω–∞ –ï–ì–≠'
        ],
        'is_free': False
    },
    'task25': {
        'emoji': '‚úçÔ∏è',
        'short_name': '–ó–∞–¥–∞–Ω–∏–µ 25',
        'full_name': '–ó–∞–¥–∞–Ω–∏–µ 25 ‚Äî –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ',
        'description': '–û–±–æ—Å–Ω–æ–≤—ã–≤–∞–π —Ç–∞–∫ —É–±–µ–¥–∏—Ç–µ–ª—å–Ω–æ, —á—Ç–æ —ç–∫—Å–ø–µ—Ä—Ç –ø–æ—Å—Ç–∞–≤–∏—Ç 6/6',
        'features': [
            '–ü–æ–¥–±–∏—Ä–∞–π –ø—Ä–∏–º–µ—Ä—ã –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Å—Ñ–µ—Ä',
            '–ò–ò –æ—Ü–µ–Ω–∏—Ç —Ç–≤–æ—ë –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ',
            '–ö–æ–Ω–∫—Ä–µ—Ç–∏–∑–∏—Ä—É–π —Ç–æ—á–Ω–æ –∏ —á—ë—Ç–∫–æ',
            '–ü–æ–ª—É—á–∞–π —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å'
        ],
        'is_free': False
    }
}

# ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================

def get_plan_price_kopecks(plan_id: str, months: int = 1) -> int:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ü–µ–Ω—É –ø–ª–∞–Ω–∞ –≤ –∫–æ–ø–µ–π–∫–∞—Ö –¥–ª—è Tinkoff API.
    
    Args:
        plan_id: ID –ø–ª–∞–Ω–∞ (trial_7days –∏–ª–∏ package_full)
        months: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—è—Ü–µ–≤
    
    Returns:
        –¶–µ–Ω–∞ –≤ –∫–æ–ø–µ–π–∫–∞—Ö
    """
    plan = SUBSCRIPTION_PLANS.get(plan_id)
    if not plan:
        raise ValueError(f"Unknown plan: {plan_id}")
    
    base_price = plan['price_rub']
    
    # –î–ª—è –ø—Ä–æ–±–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ –≤—Å–µ–≥–¥–∞ 1‚ÇΩ
    if plan_id == 'trial_7days':
        return 100  # 1‚ÇΩ –≤ –∫–æ–ø–µ–π–∫–∞—Ö
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª—å –¥–ª—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    if months in DURATION_DISCOUNTS:
        multiplier = DURATION_DISCOUNTS[months]['multiplier']
        total_price = int(base_price * multiplier)
    else:
        total_price = base_price * months
    
    return total_price * 100  # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –∫–æ–ø–µ–π–∫–∏


def get_subscription_end_date(plan_id: str, months: int = 1) -> datetime:
    """
    –í—ã—á–∏—Å–ª—è–µ—Ç –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è –ø–ª–∞–Ω–∞.
    
    Args:
        plan_id: ID –ø–ª–∞–Ω–∞
        months: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—è—Ü–µ–≤
        
    Returns:
        –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
    """
    plan = SUBSCRIPTION_PLANS.get(plan_id)
    if not plan:
        raise ValueError(f"Unknown plan: {plan_id}")
    
    if plan_id == 'trial_7days':
        return datetime.now(timezone.utc) + timedelta(days=7)
    else:
        days = 30 * months
        return datetime.now(timezone.utc) + timedelta(days=days)


def calculate_subscription_price(plan_id: str, months: int = 1) -> int:
    """
    –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ü–µ–Ω—É –ø–æ–¥–ø–∏—Å–∫–∏ —Å —É—á–µ—Ç–æ–º —Å—Ä–æ–∫–∞ –∏ —Å–∫–∏–¥–æ–∫.
    
    Args:
        plan_id: ID –ø–ª–∞–Ω–∞
        months: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—è—Ü–µ–≤
        
    Returns:
        –¶–µ–Ω–∞ –≤ –†–£–ë–õ–Ø–• (–Ω–µ –≤ –∫–æ–ø–µ–π–∫–∞—Ö!)
    """
    plan = SUBSCRIPTION_PLANS.get(plan_id)
    if not plan:
        raise ValueError(f"Unknown plan: {plan_id}")
    
    base_price = plan['price_rub']
    
    # –î–ª—è –ø—Ä–æ–±–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ –≤—Å–µ–≥–¥–∞ 1‚ÇΩ
    if plan_id == 'trial_7days':
        return 1
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–∫–∏–¥–∫–∏ –¥–ª—è –º–Ω–æ–≥–æ–º–µ—Å—è—á–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
    if months in DURATION_DISCOUNTS:
        multiplier = DURATION_DISCOUNTS[months]['multiplier']
        total_price = int(base_price * multiplier)
    else:
        total_price = base_price * months
    
    return total_price


def get_plan_modules(plan_id: str) -> List[str]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –º–æ–¥—É–ª–µ–π –¥–ª—è –ø–ª–∞–Ω–∞.
    
    Args:
        plan_id: ID –ø–ª–∞–Ω–∞
        
    Returns:
        –°–ø–∏—Å–æ–∫ –∫–æ–¥–æ–≤ –º–æ–¥—É–ª–µ–π
    """
    plan = SUBSCRIPTION_PLANS.get(plan_id)
    if not plan:
        return []
    
    modules = plan.get('modules', [])
    
    # –î–æ–±–∞–≤–ª—è–µ–º –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –º–æ–¥—É–ª–∏ –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
    for free_module in FREE_MODULES:
        if free_module not in modules:
            modules.append(free_module)
    
    return modules


def format_price(price_rub: int) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ü–µ–Ω—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è."""
    return f"{price_rub}‚ÇΩ"


def is_module_free(module_code: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –º–æ–¥—É–ª—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–º."""
    return module_code in FREE_MODULES


def get_module_info(module_code: str) -> Dict[str, Any]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–¥—É–ª–µ –¥–ª—è UI.
    
    Args:
        module_code: –ö–æ–¥ –º–æ–¥—É–ª—è
        
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –º–æ–¥—É–ª–µ
    """
    if module_code in MODULE_DESCRIPTIONS:
        info = MODULE_DESCRIPTIONS[module_code].copy()
        info['price'] = 0 if module_code in FREE_MODULES else None
        return info
    
    # –î–µ—Ñ–æ–ª—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    return {
        'emoji': 'üìö',
        'short_name': module_code,
        'full_name': module_code,
        'description': '–ú–æ–¥—É–ª—å',
        'features': [],
        'is_free': module_code in FREE_MODULES,
        'price': 0 if module_code in FREE_MODULES else None
    }


def get_plan_info(plan_id: str) -> Optional[Dict[str, Any]]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–ª–∞–Ω–µ –ø–æ–¥–ø–∏—Å–∫–∏.

    Args:
        plan_id: ID –ø–ª–∞–Ω–∞

    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–ª–∞–Ω–µ –∏–ª–∏ None
    """
    return SUBSCRIPTION_PLANS.get(plan_id)


def is_teacher_plan(plan_id: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–ª–∞–Ω –ø–æ–¥–ø–∏—Å–∫–æ–π —É—á–∏—Ç–µ–ª—è.

    Args:
        plan_id: ID –ø–ª–∞–Ω–∞

    Returns:
        True –µ—Å–ª–∏ –ø–ª–∞–Ω –¥–ª—è —É—á–∏—Ç–µ–ª—è
    """
    plan = SUBSCRIPTION_PLANS.get(plan_id)
    if not plan:
        return False
    return plan.get('type') == 'teacher'


def is_student_plan(plan_id: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–ª–∞–Ω –ø–æ–¥–ø–∏—Å–∫–æ–π —É—á–µ–Ω–∏–∫–∞.

    Args:
        plan_id: ID –ø–ª–∞–Ω–∞

    Returns:
        True –µ—Å–ª–∏ –ø–ª–∞–Ω –¥–ª—è —É—á–µ–Ω–∏–∫–∞
    """
    plan = SUBSCRIPTION_PLANS.get(plan_id)
    if not plan:
        return False
    return plan.get('type') == 'student'


def get_teacher_max_students(plan_id: str) -> int:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–µ–Ω–∏–∫–æ–≤ –¥–ª—è –ø–ª–∞–Ω–∞ —É—á–∏—Ç–µ–ª—è.

    Args:
        plan_id: ID –ø–ª–∞–Ω–∞ —É—á–∏—Ç–µ–ª—è

    Returns:
        –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–µ–Ω–∏–∫–æ–≤ (-1 –¥–ª—è –±–µ–∑–ª–∏–º–∏—Ç–∞, 0 –µ—Å–ª–∏ –Ω–µ –ø–ª–∞–Ω —É—á–∏—Ç–µ–ª—è)
    """
    plan = SUBSCRIPTION_PLANS.get(plan_id)
    if not plan or plan.get('type') != 'teacher':
        return 0
    return plan.get('max_students', 0)


def get_all_teacher_plans() -> List[Dict[str, Any]]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–ª–∞–Ω–æ–≤ –ø–æ–¥–ø–∏—Å–æ–∫ –¥–ª—è —É—á–∏—Ç–µ–ª–µ–π.

    Returns:
        –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–ª–∞–Ω–∞—Ö —É—á–∏—Ç–µ–ª–µ–π
    """
    teacher_plans = []
    for plan_id, plan_info in SUBSCRIPTION_PLANS.items():
        if plan_info.get('type') == 'teacher':
            plan_copy = plan_info.copy()
            plan_copy['plan_id'] = plan_id
            teacher_plans.append(plan_copy)

    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ü–µ–Ω–µ
    teacher_plans.sort(key=lambda x: x['price_rub'])
    return teacher_plans


def get_student_discount_plan() -> Optional[str]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç ID –ø–ª–∞–Ω–∞ —Å–æ —Å–∫–∏–¥–∫–æ–π –¥–ª—è —É—á–µ–Ω–∏–∫–æ–≤ –æ—Ç —É—á–∏—Ç–µ–ª—è.

    Returns:
        ID –ø–ª–∞–Ω–∞ –∏–ª–∏ None
    """
    for plan_id, plan_info in SUBSCRIPTION_PLANS.items():
        if plan_info.get('type') == 'student':
            return plan_id
    return None


# ==================== LEGACY SUPPORT ====================
# –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ —Å—Ç–∞—Ä—ã–º –∫–æ–¥–æ–º
LEGACY_SUBSCRIPTION_PLANS = {}

# –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
__all__ = [
    'TINKOFF_TERMINAL_KEY',
    'TINKOFF_SECRET_KEY',
    'TINKOFF_API_URL',
    'WEBHOOK_URL',
    'PAYMENT_ADMIN_CHAT_ID',
    'DATABASE_FILE',  # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π DATABASE_FILE
    'DATABASE_PATH',  # –ê–ª–∏–∞—Å –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    'SUBSCRIPTION_MODE',
    'FREE_MODULES',
    'FREEMIUM_MODULES',
    'MODULE_PLANS',
    'SUBSCRIPTION_PLANS',
    'DURATION_DISCOUNTS',
    'MODULE_DESCRIPTIONS',
    'ConfigValidationError',  # –ù–û–í–û–ï: –ö–ª–∞—Å—Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è
    'validate_config',  # –ù–û–í–û–ï: –§—É–Ω–∫—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    'get_config_status',  # –ù–û–í–û–ï: –§—É–Ω–∫—Ü–∏—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
    'get_plan_price_kopecks',
    'get_subscription_end_date',
    'calculate_subscription_price',
    'get_plan_modules',
    'format_price',
    'is_module_free',
    'get_module_info',
    'get_plan_info',
    'is_teacher_plan',
    'is_student_plan',
    'get_teacher_max_students',
    'get_all_teacher_plans',
    'get_student_discount_plan'
]
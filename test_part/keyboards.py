# test_part/keyboards.py
from typing import List, Optional
import logging
from telegram import InlineKeyboardButton, InlineKeyboardMarkup
from core.universal_ui import AdaptiveKeyboards, UniversalUIComponents

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã
from .utils import TestPartCallbackData as CallbackData

try:
    from .topic_data import TOPIC_NAMES
except ImportError:
    logging.error("–ù–µ –Ω–∞–π–¥–µ–Ω —Ñ–∞–π–ª topic_data.py –∏–ª–∏ —Å–ª–æ–≤–∞—Ä—å TOPIC_NAMES –≤ –Ω—ë–º.")
    TOPIC_NAMES: dict = {}

def get_main_menu_keyboard() -> InlineKeyboardMarkup:
    """–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –ø–ª–∞–≥–∏–Ω–æ–≤."""
    return InlineKeyboardMarkup([
        [
            InlineKeyboardButton("–¢–µ—Å—Ç–æ–≤–∞—è —á–∞—Å—Ç—å", callback_data=CallbackData.get_plugin_entry("test_part")),
            InlineKeyboardButton("–ó–∞–¥–∞–Ω–∏–µ 24", callback_data=CallbackData.get_plugin_entry("task24")),
        ]
    ])

def get_initial_choice_keyboard() -> InlineKeyboardMarkup:
    """–û—Å–Ω–æ–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞."""
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("üéØ –†–µ–∂–∏–º —ç–∫–∑–∞–º–µ–Ω–∞ (1-16)", callback_data="initial:exam_mode")],  # –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê
        [InlineKeyboardButton("üìù –ü–æ –Ω–æ–º–µ—Ä—É –∑–∞–¥–∞–Ω–∏—è", callback_data="initial:select_exam_num")],
        [InlineKeyboardButton("üìö –ü–æ –±–ª–æ–∫–∞–º —Ç–µ–º", callback_data="initial:select_block")],
        [InlineKeyboardButton("üé≤ –°–ª—É—á–∞–π–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã", callback_data="initial:select_random_all")],
        [InlineKeyboardButton("üîß –†–∞–±–æ—Ç–∞ –Ω–∞–¥ –æ—à–∏–±–∫–∞–º–∏", callback_data="initial:select_mistakes")],
        [InlineKeyboardButton("üìä –ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å", callback_data="test_part_progress")],
        [InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="to_main_menu")]
    ])

def get_exam_results_keyboard() -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —ç–∫–∑–∞–º–µ–Ω–∞."""
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("üìä –ü–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞–∑–±–æ—Ä", callback_data="exam_detailed_review")],
        [InlineKeyboardButton("üîÑ –ü—Ä–æ–π—Ç–∏ —ç–∫–∑–∞–º–µ–Ω —Å–Ω–æ–≤–∞", callback_data="initial:exam_mode")],
        [InlineKeyboardButton("üîß –†–∞–±–æ—Ç–∞ –Ω–∞–¥ –æ—à–∏–±–∫–∞–º–∏", callback_data="initial:select_mistakes")],
        [InlineKeyboardButton("üîô –ö –≤—ã–±–æ—Ä—É —Ä–µ–∂–∏–º–∞", callback_data="to_test_part_menu")]
    ])

def get_blocks_keyboard(blocks: List[str]) -> Optional[InlineKeyboardMarkup]:
    """–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞ –±–ª–æ–∫–∞."""
    if not blocks:
        return None
    
    buttons = []
    row = []
    
    for i, block in enumerate(blocks, 1):
        button = InlineKeyboardButton(
            text=block, 
            callback_data=f"block:select:{block}"
        )
        row.append(button)
        
        if i % 2 == 0:
            buttons.append(row)
            row = []
    
    if row:
        buttons.append(row)
    
    buttons.append([InlineKeyboardButton(
        "‚¨ÖÔ∏è –ù–∞–∑–∞–¥", 
        callback_data="block:back_to_initial"
    )])
    
    return InlineKeyboardMarkup(buttons) 

def get_mode_keyboard(block_name: str) -> InlineKeyboardMarkup:
    """–í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ *–≤–Ω—É—Ç—Ä–∏* –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –±–ª–æ–∫–∞."""
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("üé≤ –°–ª—É—á–∞–π–Ω—ã–µ –∏–∑ –±–ª–æ–∫–∞", callback_data="mode:random")],
        [InlineKeyboardButton("üìö –ü–æ —Ç–µ–º–µ –±–ª–æ–∫–∞", callback_data="mode:choose_topic")],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –±–ª–æ–∫–∞–º", callback_data="to_blocks")],
        [InlineKeyboardButton("üîô –ö –≤—ã–±–æ—Ä—É —Ä–µ–∂–∏–º–∞", callback_data="to_test_part_menu")]
    ])

def get_topics_keyboard(block_name: str, topics: List[str]) -> Optional[InlineKeyboardMarkup]:
    """–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–µ–º—ã."""
    if not topics:
        return None
    
    buttons = []
    
    # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ç–µ–º
    for topic in topics:
        topic_display = TOPIC_NAMES.get(topic, topic)
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É —Ç–µ–∫—Å—Ç–∞ –∫–Ω–æ–ø–∫–∏
        if len(topic_display) > 35:
            topic_display = topic_display[:32] + "..."
        
        buttons.append([InlineKeyboardButton(
            topic_display, 
            callback_data=f"topic:{topic}"
        )])
    
    # –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    buttons.append([InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Ä–µ–∂–∏–º—É", callback_data="to_mode")])
    buttons.append([InlineKeyboardButton("üîô –ö –≤—ã–±–æ—Ä—É —Ä–µ–∂–∏–º–∞", callback_data="to_test_part_menu")])
    
    return InlineKeyboardMarkup(buttons)

def get_exam_num_keyboard(numbers: List[int]) -> Optional[InlineKeyboardMarkup]:
    """–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–æ–º–µ—Ä–∞ –∑–∞–¥–∞–Ω–∏—è –ï–ì–≠."""
    if not numbers:
        return None
    
    # –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ (1-27 –¥–ª—è –ï–ì–≠ –ø–æ –æ–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏—é)
    valid_numbers = [n for n in numbers if 1 <= n <= 27]
    
    if not valid_numbers:
        return None
    
    buttons = []
    row = []
    
    for i, number in enumerate(sorted(valid_numbers), 1):
        button = InlineKeyboardButton(
            text=str(number),
            callback_data=f"exam_number:select:{number}"
        )
        row.append(button)
        
        # –ü–æ 6 –∫–Ω–æ–ø–æ–∫ –≤ —Ä—è–¥
        if i % 6 == 0:
            buttons.append(row)
            row = []
    
    # –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –∫–Ω–æ–ø–∫–∏
    if row:
        buttons.append(row)
    
    # –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥
    buttons.append([InlineKeyboardButton(
        "‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
        callback_data="exam_number:back_to_initial"
    )])
    
    return InlineKeyboardMarkup(buttons)

def get_after_answer_keyboard(last_mode: str = "random") -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–≤–µ—Ç–∞."""
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –∫–Ω–æ–ø–∫–∏ "—Å–ª–µ–¥—É—é—â–∏–π"
    if last_mode == "topic":
        main_button = InlineKeyboardButton("‚û°Ô∏è –ï—â—ë –≤–æ–ø—Ä–æ—Å –ø–æ —Ç–µ–º–µ", callback_data=CallbackData.TEST_NEXT_TOPIC)
    elif last_mode == "exam_num":
        main_button = InlineKeyboardButton("‚û°Ô∏è –°–ª–µ–¥—É—é—â–∏–π –Ω–æ–º–µ—Ä", callback_data=CallbackData.TEST_NEXT_RANDOM)
    else:  # random
        main_button = InlineKeyboardButton("‚û°Ô∏è –ï—â—ë —Å–ª—É—á–∞–π–Ω—ã–π", callback_data=CallbackData.TEST_NEXT_RANDOM)

    return InlineKeyboardMarkup([
        [main_button],
        [InlineKeyboardButton("üîÑ –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É / —Ä–µ–∂–∏–º", callback_data=CallbackData.TEST_CHANGE_TOPIC)],
        [InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data=CallbackData.TEST_TO_MAIN_MENU)],
    ])

def get_mistakes_nav_keyboard() -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –æ—à–∏–±–∫–∞–º."""
    return InlineKeyboardMarkup([
        [
            InlineKeyboardButton(
                "‚û°Ô∏è –°–ª–µ–¥—É—é—â–∞—è –æ—à–∏–±–∫–∞",
                callback_data="test_next_continue",
            )
        ],
        [
            InlineKeyboardButton(
                "‚è© –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å",
                callback_data="test_mistake_skip",
            )
        ],
        [
            InlineKeyboardButton(
                "üö™ –ó–∞–∫–æ–Ω—á–∏—Ç—å —Ä–∞–∑–±–æ—Ä",
                callback_data="test_mistake_finish",
            )
        ],
        [
            InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="to_main_menu")
        ],
    ])

def get_question_keyboard(mode: str) -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ —Å –∫–Ω–æ–ø–∫–æ–π –ø—Ä–æ–ø—É—Å–∫–∞."""
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤–æ–ø—Ä–æ—Å", callback_data=f"skip_question:{mode}")]
    ])

def get_next_action_keyboard(last_mode: str, has_explanation: bool = False, exam_number: int = None) -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ (–û–°–ù–û–í–ù–ê–Ø –í–ï–†–°–ò–Ø)."""
    keyboard = []
    
    # –ü–µ—Ä–≤—ã–π —Ä—è–¥ - –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    first_row = []
    
    # –ö–Ω–æ–ø–∫–∞ "–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å"
    if last_mode == "topic":
        next_text = "‚û°Ô∏è –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å –ø–æ —Ç–µ–º–µ"
    elif last_mode == "exam_num":
        # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–º–µ—Ä –∑–∞–¥–∞–Ω–∏—è –µ—Å–ª–∏ –æ–Ω –ø–µ—Ä–µ–¥–∞–Ω
        if exam_number:
            next_text = f"‚û°Ô∏è –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å ‚Ññ{exam_number}"
        else:
            next_text = "‚û°Ô∏è –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å"
    elif last_mode == "block":
        next_text = "‚û°Ô∏è –°–ª–µ–¥—É—é—â–∏–π –∏–∑ –±–ª–æ–∫–∞"
    elif last_mode == "mistakes":
        next_text = "‚û°Ô∏è –°–ª–µ–¥—É—é—â–∞—è –æ—à–∏–±–∫–∞"
    else:  # random_all
        next_text = "‚û°Ô∏è –°–ª–µ–¥—É—é—â–∏–π —Å–ª—É—á–∞–π–Ω—ã–π"
    
    first_row.append(
        InlineKeyboardButton(
            next_text, callback_data=CallbackData.TEST_NEXT_CONTINUE
        )
    )
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø–æ—è—Å–Ω–µ–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å (–≤–æ –≤—Ç–æ—Ä–æ–π —Ä—è–¥ –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è)
    keyboard.append(first_row)
    
    # –í—Ç–æ—Ä–æ–π —Ä—è–¥ - –ø–æ—è—Å–Ω–µ–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    if has_explanation:
        keyboard.append([
            InlineKeyboardButton(
                "üí° –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—è—Å–Ω–µ–Ω–∏–µ",
                callback_data=CallbackData.TEST_NEXT_SHOW_EXPLANATION,
            )
        ])
    
    # –¢—Ä–µ—Ç–∏–π —Ä—è–¥ - –Ω–∞–≤–∏–≥–∞—Ü–∏—è
    nav_row = []
    
    if last_mode in ["topic", "exam_num", "block"]:
        nav_row.append(
            InlineKeyboardButton(
                "üîÑ –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É", 
                callback_data=CallbackData.TEST_NEXT_CHANGE_TOPIC
            )
        )
    else:
        nav_row.append(
            InlineKeyboardButton(
                "üîÑ –°–º–µ–Ω–∏—Ç—å —Ä–µ–∂–∏–º", 
                callback_data=CallbackData.TEST_NEXT_CHANGE_TOPIC
            )
        )
    
    keyboard.append(nav_row)
    
    # –ß–µ—Ç–≤–µ—Ä—Ç—ã–π —Ä—è–¥ - –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    keyboard.append([
        InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="to_main_menu")
    ])
    
    return InlineKeyboardMarkup(keyboard)

def get_subscription_keyboard(channel: str) -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏."""
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("‚úÖ –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è", url=f"https://t.me/{channel.lstrip('@')}")],
        [InlineKeyboardButton("üîÑ –Ø –ø–æ–¥–ø–∏—Å–∞–ª—Å—è", callback_data="check_subscription")]
    ])

def get_error_keyboard() -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –æ—à–∏–±–æ–∫."""
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞", callback_data="to_test_part_menu")],
        [InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="to_main_menu")]
    ])

def get_stats_keyboard() -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏."""
    return AdaptiveKeyboards.create_progress_keyboard(
        has_detailed_stats=True,
        can_export=True,
        module_code="test"
    )

def get_progress_keyboard() -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —ç–∫—Ä–∞–Ω–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞."""
    return InlineKeyboardMarkup([
        [
            InlineKeyboardButton("üìä –ü–æ–¥—Ä–æ–±–Ω–µ–µ", callback_data="test_detailed_analysis"),
            InlineKeyboardButton("üì• –≠–∫—Å–ø–æ—Ä—Ç", callback_data="test_export_csv")
        ],
        [InlineKeyboardButton("üîß –†–∞–±–æ—Ç–∞ –Ω–∞–¥ –æ—à–∏–±–∫–∞–º–∏", callback_data="test_work_mistakes")],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="to_test_part_menu")]
    ])

def get_mistakes_finish_keyboard() -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –Ω–∞–¥ –æ—à–∏–±–∫–∞–º–∏."""
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="test_part_progress")],
        [InlineKeyboardButton("üé≤ –°–ª—É—á–∞–π–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã", callback_data="initial:select_random_all")],
        [InlineKeyboardButton("üîô –ö –≤—ã–±–æ—Ä—É —Ä–µ–∂–∏–º–∞", callback_data="to_test_part_menu")]
    ])

def get_adaptive_result_keyboard(is_correct: bool, has_explanation: bool = False) -> InlineKeyboardMarkup:
    """–ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤."""
    # –ë–∞–∑–æ–≤–∞—è –∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
    kb = AdaptiveKeyboards.create_result_keyboard(
        score=1 if is_correct else 0,
        max_score=1,
        module_code="test"
    )
    
    # –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º callback_data –ø–æ–¥ test_part
    kb_list = list(kb.inline_keyboard)
    
    for row in kb_list:
        for button in row:
            # –ú–∞–ø–ø–∏–Ω–≥ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã—Ö callback –Ω–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ
            if "–Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ" in button.text.lower():
                button.callback_data = CallbackData.TEST_NEXT_CONTINUE
            elif "–ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞" in button.text.lower():
                button.callback_data = "test_retry"
            elif "–º–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å" in button.text.lower():
                button.callback_data = "test_progress"
            elif "–≤ –º–µ–Ω—é" in button.text.lower() and button.callback_data != "to_main_menu":
                button.callback_data = "to_test_part_menu"
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø–æ—è—Å–Ω–µ–Ω–∏—è –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if has_explanation:
        kb_list.insert(1, [InlineKeyboardButton(
            "üí° –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—è—Å–Ω–µ–Ω–∏–µ",
            callback_data=CallbackData.TEST_NEXT_SHOW_EXPLANATION
        )])
    
    return InlineKeyboardMarkup(kb_list)
